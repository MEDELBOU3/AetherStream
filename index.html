<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>AetherStream — Ultimate Provider Edition</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href='https://cdn.boxicons.com/3.0.6/fonts/basic/boxicons.min.css' rel='stylesheet'>

  <!-- GSAP Suite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>


  <link rel="stylesheet" href="css/main.css">
</head>

<body>

  <div class="noise-overlay"></div>

  <!-- VIDEO MODAL -->
  <div class="video-modal" id="videoModal">
    <!-- Clickable Backdrop -->
    <div class="modal-bg" onclick="app.closeVideo()"></div>

    <div class="video-wrapper" id="videoWrapper">
      <!-- Header with Metadata -->
      <div class="video-header">
        <div class="playing-badge">
          <span class="pulse-dot"></span> NOW PLAYING
        </div>
        <h2 id="videoTitleLabel">Untitled</h2>
      </div>

      <!-- Close Button (Floating) -->
      <div class="close-video-btn magnetic" onclick="app.closeVideo()">
        <span style="font-size:12px; font-weight:700; letter-spacing:1px;">CLOSE</span>
        <div class="close-icon-circle"><i class="fas fa-times"></i></div>
      </div>

      <!-- Loader -->
      <div class="video-loader" id="videoLoader">
        <svg viewBox="0 0 50 50" class="spinner">
          <circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
        </svg>
      </div>

      <!-- Iframe Container -->
      <div id="videoContainer" class="video-frame-box"></div>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div class="video-modal" id="editProfileModal" style="z-index: 6000;">
    <div class="modal-bg" onclick="socialUI.closeEditModal()"></div>

    <div class="auth-card edit-card"
      style="width:400px; max-width:90%; background:var(--surface-glass); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:20px; padding:30px; position:relative;">

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; font-family:'Playfair Display';">Edit Profile</h2>
        <div onclick="socialUI.closeEditModal()" style="cursor:pointer; font-size:20px;">✕</div>
      </div>

      <div class="setting-group">
        <div class="input-label">Display Name</div>
        <input type="text" id="editDisplayName" class="cyber-input" maxlength="20">
      </div>

      <div class="setting-group">
        <div class="input-label">Bio</div>
        <textarea id="editBio" class="cyber-input" rows="4" maxlength="150" style="resize:none;"></textarea>
        <div style="text-align:right; font-size:11px; color:gray; margin-top:5px;" id="bioCharCount">0/150</div>
      </div>

      <button class="btn btn-primary" id="saveProfileBtn" onclick="socialUI.saveProfileChanges()"
        style="width:100%; justify-content:center;">
        Save Changes
      </button>

    </div>
  </div>

  <!-- ADD PROFILE MODAL -->
  <div class="video-modal" id="addProfileModal" style="z-index: 10000;">
    <div class="modal-bg" onclick="profileGateUI.closeAddModal()"></div>

    <div class="auth-card"
      style="width:400px; max-width:90%; background:var(--surface-glass); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:20px; padding:30px; position:relative;">

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; font-family:'Playfair Display';">New Profile</h2>
        <div onclick="profileGateUI.closeAddModal()" style="cursor:pointer; font-size:20px;">✕</div>
      </div>

      <!-- Avatar Preview -->
      <div style="text-align:center; margin-bottom:20px;">
        <img id="newProfileAvatarPreview" src="https://i.pinimg.com/736x/ff/a6/42/ffa6421da8b8b6b345f26bc1f8a90139.jpg"
          style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid var(--border);">
      </div>

      <div class="setting-group">
        <div class="input-label">Profile Name</div>
        <input type="text" id="newProfileName" class="cyber-input" placeholder="Name" maxlength="15">
      </div>

      <!-- Kid Toggle -->
      <div class="setting-group"
        style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
        <div>
          <div class="input-label" style="margin:0; color:#fff;">Kids Profile</div>
          <div style="font-size:11px; color:gray;">Curated content only (PG/G)</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="newProfileIsKids" onchange="profileGateUI.toggleNewProfileMode()">
          <span class="slider"></span>
        </label>
      </div>

      <button class="btn btn-primary" onclick="profileGateUI.submitNewProfile()"
        style="width:100%; justify-content:center; margin-top:20px;">
        Create Profile
      </button>
    </div>
  </div>

  <!-- SEARCH OVERLAY -->
  <div class="search-overlay" id="searchOverlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
      <div class="brand">SEARCH</div>
      <div class="nav-icon" style="font-size:24px; cursor:pointer;" onclick="app.toggleSearch()">✕</div>
    </div>
    <div class="search-input-wrap">
      <input type="text" class="search-input" id="searchInput" placeholder="Search Movies & TV..." autocomplete="off">
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <!-- ADVANCED PROVIDER GRID OVERLAY -->
  <div class="provider-overlay" id="providerOverlay">
    <div class="provider-overlay-header">
      <div>
        <h2 style="font-family:'Playfair Display'; font-size:2.5rem; margin:0; line-height:1;">Global Providers</h2>
        <p style="color:#888; margin:5px 0 0; font-size:14px;">Select a network to browse content</p>
      </div>
      <button class="nav-icon" style="font-size:28px;" onclick="app.toggleProviderGrid(false)">✕</button>
    </div>
    <div class="provider-grid-container">
      <div class="provider-grid" id="providerGrid"></div>
      <button class="load-more-btn" id="providerLoadMoreBtn" onclick="app.renderProviderBatch()">Load More
        Providers</button>
    </div>
  </div>

  <!-- PROFILE GATE (Who is watching?) -->
  <section id="profileGateView" class="profile-gate">
    <div class="gate-content">
      <h1 class="gate-title">Who's watching?</h1>
      <div class="gate-grid" id="profileGateGrid">
      </div>
      <button class="gate-manage-btn" id="manageProfilesBtn" onclick="profileGateUI.toggleManageMode()">
        Manage Profiles
      </button>
    </div>
  </section>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar">
    <div class="brand" onclick="app.go('home')">AETHER<span>.</span></div>

    <div class="nav-actions">
      <div class="nav-icon magnetic" onclick="missionUI.open()" title="Challenges & XP">
        <i class="fas fa-trophy" style="color: gold;"></i>
      </div>
      <div class="nav-icon magnetic" onclick="oracleUI.open()" title="Mood Matcher">
        <i class='bx  bx-sparkles' style="color:var(--accent);"></i>
      </div>
      <div class="nav-icon magnetic" onclick="app.toggleSearch()"><i class="fas fa-search"></i></div>
      <div class="profile-wrapper magnetic-avatar" onclick="app.profileClick()">
        <!-- The glowing ring behind -->
        <div class="profile-glow"></div>

        <!-- The main container -->
        <div class="profile-inner">
          <img src="https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png" alt="User"
            class="profile-img">
          <!-- Status Dot -->
          <div class="status-indicator"></div>
        </div>
      </div>
      <div class="menu-trigger magnetic" id="menuToggle">
        <span>Menu</span>
        <div class="burger-icon">
          <div class="burger-line"></div>
          <div class="burger-line"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR TRIGGER -->
  <button class="sidebar-trigger" id="sidebarToggle">Genres</button>

  <!-- FULLSCREEN MENU -->
  <div class="fs-menu" id="fsMenu">
    <div style="text-align:center;">
      <a class="fs-link" onclick="app.go('home')"><span>01</span> Home</a>
      <a class="fs-link" onclick="app.go('watchlist')"><span>02</span> Watchlist</a>
      <a class="fs-link" onclick="app.go('originals')"><span>03</span> Originals</a>
      <a class="fs-link" onclick="app.go('profile')"><span>04</span> Profile</a>
      <a class="fs-link" onclick="app.go('settings')"><span>05</span> Settings</a>
    </div>
  </div>

  <!-- GENRE SIDEBAR -->
  <aside class="genre-sidebar" id="genreSidebar">

    <!-- 1. Header -->
    <div class="sidebar-header">
      <h2 class="sidebar-logo">Aether<span>.</span></h2>
      <button class="close-sidebar-btn" onclick="app.toggleSidebar(false)">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- 2. Scrollable Area -->
    <div class="sidebar-scroll-area">

      <!-- A. Search -->
      <div class="sidebar-search-wrap">
        <i class="fas fa-search"></i>
        <input type="text" id="genreFilterInput" placeholder="Find pages..." autocomplete="off">
      </div>

      <!-- B. Quick History (New Feature) -->
      <div id="sidebarHistorySection" style="display:none;">
        <div class="sidebar-section-title">Continue Watching</div>
        <div class="sidebar-history-list" id="sidebarHistoryList">
          <!-- Injected via JS -->
        </div>
      </div>

      <!-- C. Discover Links -->
      <div class="sidebar-section-title">Discover</div>
      <div class="nav-list" id="discoverList"></div>

      <!-- D. Genre Tags (Visual Update) -->
      <div class="sidebar-section-title">Browse Categories</div>
      <div class="genre-cloud" id="genreList"></div>
    </div>

    <!-- 3. Sticky Footer (User) -->
    <div class="sidebar-footer">
      <div class="footer-user" onclick="app.go('profile')">
        <img id="sidebarAvatar" src="" alt="User">
        <div class="footer-info">
          <span id="sidebarName">Guest</span>
          <small>View Profile</small>
        </div>
      </div>
      <button class="footer-settings-btn" onclick="app.go('settings')">
        <i class="fas fa-cog"></i>
      </button>
    </div>

  </aside>

  <!-- CLOSE BUTTON FOR SUB-VIEWS -->
  <div class="close-view magnetic" id="closeViewBtn" onclick="app.go('home')">
    <i class="fas fa-times"></i>
  </div>

  <!-- VIEW: HOME -->
  <main id="view-home" class="view-container active">
    <header class="hero">
      <img id="heroBg" class="hero-bg" src="" alt="Hero">
      <div class="hero-gradient"></div>
      <div class="hero-content">
        <div class="hero-badge">#1 Global Trending</div>
        <h1 class="hero-title" id="heroTitle">Loading...</h1>
        <p id="heroDesc" class="hero-desc"></p>
        <div style="display:flex; gap:16px;">
          <button class="btn btn-primary magnetic" id="heroPlayBtn"><i class="fas fa-play"></i> Watch Trailer</button>
          <button class="btn btn-blur magnetic" id="heroListBtn"><i class="fas fa-plus"></i> My List</button>
        </div>
      </div>
    </header>

    <div class="providers-wrap">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 4px;">
        <span
          style="font-size:12px; letter-spacing:1px; color: var(--text-muted);; text-transform:uppercase;">Partners</span>
        <span style="font-size:12px; cursor:pointer; color:var(--text); font-weight:600; transition:0.3s; opacity:0.8;"
          onmouseover="this.style.opacity=1; this.style.color='var(--accent)'"
          onmouseout="this.style.opacity=0.8; this.style.color='#fff'" onclick="app.toggleProviderGrid(true)">View All
          Providers <i class="fas fa-arrow-right" style="font-size:10px; margin-left:4px;"></i></span>
      </div>
      <div class="providers-track" id="homeProviders"></div>
    </div>

    <!-- GSAP SPOTLIGHT GRID (Dynamic) -->
    <section class="spotlight-section" id="spotlightSection">
      <div class="spotlight-vfx-layer">
        <div class="fog"></div>
        <div class="light-beam"></div>
        <div class="film-grain"></div>
      </div>

      <div class="spotlight-grid">
        <!-- LEFT COL -->
        <div class="spotlight-col-left">
          <div class="spotlight-poster-area">
            <div class="gpu poster-frame">
              <img id="spotlightPoster" src="" alt="Poster" class="spotlight-poster">
            </div>

            <h2 class="spotlight-title" id="spotlightTitle">Loading...</h2>

            <div class="spotlight-badges">
              <span class="badge" id="spotlightYear">2024</span>
              <span class="badge" id="spotlightRuntime">2h 10m</span>
              <span class="badge age">R</span>
            </div>

            <div class="spotlight-score">
              <i class="fas fa-star"></i> <span id="spotlightRating">0.0</span> <span class="source">TMDB</span>
            </div>

            <div class="spotlight-genre" id="spotlightGenres">Genre / Genre</div>

            <div class="spotlight-actions-left">
              <!-- IDs added for click handlers -->
              <button class="btn btn-primary" id="spotlightWatchBtn">Watch Now</button>
              <button class="btn btn-outline" id="spotlightListBtn">+ Playlist</button>
            </div>
          </div>
        </div>

        <!-- RIGHT COL -->
        <div class="spotlight-col-right">
          <div class="spotlight-scene-wrap" id="spotlightSceneBtn">
            <img id="spotlightBackdrop" src="" alt="Scene" class="scene-img">
            <div class="play-overlay">
              <div class="play-circle"><i class="fas fa-play"></i></div>
            </div>
            <div class="lens-flare"></div>
          </div>

          <div class="spotlight-details">
            <div class="detail-block main-desc">
              <h3>Synopsis</h3>
              <p id="spotlightDesc">Loading...</p>
            </div>

            <div class="detail-block meta-block">
              <div class="meta-row">
                <span class="label">Director</span>
                <span class="value" id="spotlightDirector">...</span>
              </div>
              <div class="meta-row">
                <span class="label">Status</span>
                <span class="value" id="spotlightStatus">Released</span>
              </div>
              <div class="meta-row">
                <span class="label">Vote Count</span>
                <span class="value" id="spotlightVotes">...</span>
              </div>
            </div>

            <div class="spotlight-cast">
              <h3>Top Cast</h3>
              <div class="cast-row" id="spotlightCast"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="spotlight-strokes" id="spotlightStrokes">
      <div class="stroke-layer layer-1">>>> >>>> >>>>> >>>>>>>></div>
      <div class="stroke-layer layer-2">>> >>> >>>> >>>>></div>
      <div class="stroke-layer layer-3">>> >> >>> >> >>></div>
    </div>
    <div id="homeRows" style="position:relative; z-index:5; "></div>

  </main>



  </main>

  <!-- VIEW: DETAIL -->
  <section id="view-detail" class="view-container">
    <img id="dtBackdrop" class="detail-backdrop" src="" alt="">
    <div class="detail-inner">
      <div class="gpu">
        <img id="dtPoster" class="detail-poster" src="" alt="">
      </div>
      <div class="detail-info">
        <h1 id="dtTitle" class="hero-title" style="font-size:3.5rem;">Title</h1>
        <div class="detail-meta">
          <span id="dtYear">2023</span> • <span id="dtRating" style="color:var(--accent)">98% Match</span> • <span
            id="dtRuntime">2h 10m</span>
        </div>
        <div class="user-rating-box">
          <span class="rating-label">Your Rating:</span>
          <div class="star-group" id="dtUserRating">
            <i class="fas fa-star star-btn" data-val="1"></i>
            <i class="fas fa-star star-btn" data-val="2"></i>
            <i class="fas fa-star star-btn" data-val="3"></i>
            <i class="fas fa-star star-btn" data-val="4"></i>
            <i class="fas fa-star star-btn" data-val="5"></i>
          </div>
        </div>
        <p id="dtDesc" class="detail-desc">Loading...</p>

        <div style="display:flex; align-items:center; gap:16px; margin-bottom:50px;">
          <button class="btn btn-primary magnetic" id="dtPlayBtn"><i class="fas fa-play"></i> Trailer</button>

          <!-- Inserted Stream Button will go here via JS -->

          <button class="btn btn-blur magnetic" id="dtListBtn"><i class="fas fa-plus"></i> List</button>

          <!-- NEW: FAVORITE BUTTON -->
          <button class="btn-icon magnetic" id="dtFavBtn" title="Add to Favorites">
            <i class="fas fa-heart"></i>
          </button>
        </div>

        <div id="seasonContainer" style="display:none;">
          <h3 style="margin-bottom:20px; font-family:'Playfair Display'; font-size:1.8rem;">Seasons</h3>
          <div class="season-list" id="dtSeasons"></div>
          <!-- Header for Episodes -->
          <h4 id="episodesHeader" style="margin: 30px 0 15px; font-size: 1.2rem; display:none;">Episodes</h4>

          <!-- List of Episodes -->
          <div class="episode-list" id="dtEpisodes"></div>
        </div>

        <h3 style="margin-bottom:20px; font-family:'Playfair Display'; font-size:1.8rem;">Top Cast</h3>
        <div class="cast-list" id="dtCast"></div>
      </div>
    </div>
    <div id="recContainer" style="margin-top:80px; padding:0 4%;"></div>
  </section>

  <!-- VIEW: NETWORK/GENRE -->
  <section id="view-network" class="view-container">
    <div class="grid-header">
      <h1 class="grid-title" id="netTitle">Network</h1>
      <p style="color:#aaa; margin-top:10px;">Curated Collection</p>
    </div>

    <!-- Movie Section -->
    <div id="netMovieSection">
      <div class="section-label">Movies</div>
      <div class="media-grid" id="netMovieGrid"></div>
      <button class="load-more-btn" id="loadMoreMovieBtn" onclick="app.loadMore('movie')">Load More Movies</button>
    </div>

    <!-- TV Section -->
    <div id="netTvSection" style="margin-top:80px;">
      <div class="section-label">TV Series</div>
      <div class="media-grid" id="netTvGrid"></div>
      <button class="load-more-btn" id="loadMoreTvBtn" onclick="app.loadMore('tv')">Load More TV</button>
    </div>
  </section>

  <!-- VIEW: WATCHLIST -->
  <section id="view-watchlist" class="view-container">
    <div class="grid-header">
      <h1 class="grid-title">Watchlist</h1>
      <p style="color:#aaa; margin-top:10px;">Your personal library</p>
    </div>
    <div class="media-grid" id="watchlistGrid"></div>
  </section>


  <!-- VIEW: SETTINGS -->
  <section id="view-settings" class="view-container">

    <div class="settings-layout">
      <!-- Sidebar -->
      <aside class="settings-sidebar">
        <h1 class="settings-title">Control Center</h1>

        <div class="settings-nav">
          <div class="set-tab active" onclick="app.switchSettingTab('general', this)">
            <i class="fas fa-user-circle"></i> General
          </div>
          <div class="set-tab" onclick="app.switchSettingTab('playback', this)">
            <i class="fas fa-play-circle"></i> Playback
          </div>
          <div class="set-tab" onclick="app.switchSettingTab('audio', this)">
            <i class="fas fa-sliders-h"></i> Audio & Subs
          </div>
          <div class="set-tab" onclick="app.switchSettingTab('system', this)">
            <i class="fas fa-microchip"></i> System
          </div>
        </div>

        <div class="plan-card">
          <div style="font-size:10px; opacity:0.6; text-transform:uppercase; letter-spacing:1px;">Current Plan</div>
          <div style="font-family:'Playfair Display'; font-size:22px; color:var(--accent); margin:5px 0;">Ultimate 4K
          </div>
          <div style="font-size:12px; opacity:0.8;">Next billing: Oct 24</div>
        </div>
      </aside>

      <!-- Content Area -->
      <div class="settings-content">
        <!-- TAB: GENERAL -->
        <div id="set-general" class="set-panel active">
          <h2 class="panel-title">Profile & Account</h2>

          <!-- CURRENT PROFILE HEADER -->
          <div class="setting-group">
            <div class="profile-header">
              <div class="avatar-large">
                <img src="" id="settingsAvatar" class="profile-img">
              </div>
              <div style="flex: 1;">
                <div class="input-label">Display Name</div>
                <input type="text" id="settingsName" class="cyber-input" value="Loading..." spellcheck="false">
              </div>
            </div>
          </div>

          <!-- NEW: SWITCH PROFILE CONTAINER -->
          <div class="setting-group" style="border-top: 1px solid var(--border); padding-top: 30px; margin-top: 30px;">
            <h3
              style="font-size:14px; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:15px;">
              Switch Profile
            </h3>

            <!-- This is where the JS injects the profiles -->
            <div class="profiles-list-row" id="settingsProfilesList" style="display:flex; gap:10px; overflow-x:auto;">
            </div>
          </div>

          <div class="setting-group" style="border-top: 1px solid var(--border); padding-top: 30px; margin-top: 30px;">
            <h3
              style="font-size:14px; text-transform:uppercase; letter-spacing:1px; margin-bottom:20px; color:var(--text-muted);">
              Content Safety
            </h3>

            <div class="control-row">
              <div class="control-info">
                <div class="control-head">Strict Safety Filter</div>
                <div class="control-sub">Block sensitive keywords and show warning warnings. (Always ON for Kids)</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingSafetyFilter" onchange="app.toggleAdultSafety()">
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <!-- APPEARANCE -->
          <div class="setting-group" style="border-top: 1px solid var(--border); padding-top: 30px; margin-top: 30px;">
            <!-- ... (Keep your Appearance/Dark Mode HTML here) ... -->
            <h3
              style="font-size:14px; text-transform:uppercase; letter-spacing:1px; margin-bottom:20px; color:var(--text-muted);">
              Appearance</h3>
            <div class="control-row">
              <div class="control-info">
                <div class="control-head">Dark Mode</div>
              </div>
              <label class="toggle-switch"><input type="checkbox" id="themeToggle" onchange="app.toggleTheme()"><span
                  class="slider"></span></label>
            </div>
          </div>

          <!-- AVATAR SELECTION (For Current Profile) -->
          <div class="setting-group" style="border-top: 1px solid var(--border); padding-top: 30px; margin-top: 30px;">
            <h3
              style="font-size:14px; text-transform:uppercase; letter-spacing:1px; margin-bottom:20px; color:var(--text-muted);">
              Change Avatar
            </h3>
            <div class="avatar-selection-grid" id="avatarGrid">
              <!-- ... (Keep your existing avatars) ... -->
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png"></div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://i.pinimg.com/736x/ff/a6/42/ffa6421da8b8b6b345f26bc1f8a90139.jpg"></div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://i.pinimg.com/736x/fd/a7/9a/fda79a9471d43a39d2d8eabc8720f8aa.jpg"></div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://i.pinimg.com/1200x/8b/c4/ba/8bc4babefe6475305f198f37a282f810.jpg"></div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://i.pinimg.com/736x/13/fb/2d/13fb2d9277d1ac839cbc29271d80d43e.jpg"></div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9rwydqfce8wwdwksbyesqs%2F1765559740_img_1.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=JYj0vGPCNOJbqjN/CHT8W/FNOPPQly08iRifsTFGZDc%3D&ac=oaivgprodscus2">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)"><img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9rwydqfce8wwdwksbyesqs%2F1765559740_img_0.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=irNV/cq0VT1tpBlDp17jC1/i2L5zLaEHvHjM/JMyd1Y%3D&ac=oaivgprodscus2">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9rqbaqfqqtb3k6hv82q51e%2F1765559560_img_0.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=P3jT%2BTQa0LsphIqgshAu208FZ6JW83ndoUXim27Jhlg%3D&ac=oaivgprodscus2"
                  alt="">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9s8sx3emj8bdpdxgqk4fnn%2F1765560130_img_0.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=4iyWolZMaGNdD4HO52cxbnRuDeieQWADyc%2BjD7TnkZs%3D&ac=oaivgprodscus2"
                  alt="">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9s8sx3emj8bdpdxgqk4fnn%2F1765560130_img_1.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=qlJ2j7Vj6dOJ06FiTJm8und/TN5lG9Len8T7pyYcY7A%3D&ac=oaivgprodscus2"
                  alt="">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9te8eyfazr4vyxqann1y4x%2F1765561364_img_1.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=cJsrlsAgyagMMG4cY8wE64QWHCSgipBACX4XgUjjiCc%3D&ac=oaivgprodscus2"
                  alt="">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9sn03pes1vgb83tmf3ne6j%2F1765560532_img_0.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=2A3/Cu6kTgxxBtFcxTZvLMfMlBUkkzFxpMa9pRH7%2BbM%3D&ac=oaivgprodscus2"
                  alt="">
              </div>
              <div class="avatar-item" onclick="app.selectAvatar(this)">
                <img
                  src="https://videos.openai.com/az/vg-assets/task_01kc9sn03pes1vgb83tmf3ne6j%2F1765560532_img_1.webp?se=2025-12-14T00%3A00%3A00Z&sp=r&sv=2024-08-04&sr=b&skoid=cfbc986b-d2bc-4088-8b71-4f962129715b&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-12-12T01%3A09%3A13Z&ske=2025-12-19T01%3A14%3A13Z&sks=b&skv=2024-08-04&sig=zlhxzpDVv8q2uaKpYXHZwlErHxunOr7io5unWz8JX7A%3D&ac=oaivgprodscus2"
                  alt="">
              </div>

            </div>
          </div>

          <div class="setting-group" style="margin-top:40px;">
            <button class="btn btn-blur" onclick="app.signOut()"
              style="width:100%; justify-content:center; border-color:var(--accent); color:var(--accent);">Sign
              Out</button>
          </div>
        </div>

        <!-- TAB: PLAYBACK -->
        <div id="set-playback" class="set-panel">
          <h2 class="panel-title">Streaming Preferences</h2>

          <div class="control-row">
            <div class="control-info">
              <div class="control-head">High Efficiency Streaming (HEVC)</div>
              <div class="control-sub">Save data without losing quality</div>
            </div>
            <label class="toggle-switch">
              <!-- Added ID -->
              <input type="checkbox" id="settingHevc" checked>
              <span class="slider"></span>
            </label>
          </div>

          <div class="setting-group" style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px;">
            <h3
              style="font-size:14px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px;">
              Visual Adjustments
            </h3>

            <!-- ZOOM SLIDER -->
            <div class="setting-group">
              <div style="display:flex; justify-content:space-between;">
                <div class="input-label">Cinema Zoom / Crop</div>
                <div class="input-label" id="zoomVal">1.0x</div>
              </div>
              <input type="range" id="settingZoom" min="1" max="1.5" step="0.05" value="1" class="cyber-range"
                oninput="document.getElementById('zoomVal').innerText = this.value + 'x'; player.syncSettings();">
              <div style="font-size:11px; color:#666; margin-top:5px;">
                Useful for removing black bars or enlarging subtitles.
              </div>
            </div>

            <!-- BRIGHTNESS SLIDER -->
            <div class="setting-group">
              <div style="display:flex; justify-content:space-between;">
                <div class="input-label">Brightness</div>
                <div class="input-label" id="brightVal">100%</div>
              </div>
              <input type="range" id="settingBrightness" min="0.5" max="1.5" step="0.1" value="1" class="cyber-range"
                oninput="document.getElementById('brightVal').innerText = Math.round(this.value*100) + '%'; player.syncSettings();">
            </div>

          </div>

          <div class="control-row">
            <div class="control-info">
              <div class="control-head">Autoplay Trailers & Streams</div>
              <div class="control-sub">Start video immediately on load</div>
            </div>
            <label class="toggle-switch">
              <!-- Added ID -->
              <input type="checkbox" id="settingAutoplay" checked>
              <span class="slider"></span>
            </label>
          </div>

          <div class="control-row">
            <div class="control-info">
              <div class="control-head">Hardware Acceleration</div>
              <div class="control-sub">Use GPU for smoother UI rendering</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>

          <div class="setting-group">
            <div class="input-label">Preferred Streaming Source</div>
            <div class="select-wrapper">
              <!-- ID added: providerSelect -->
              <select class="cyber-select" id="providerSelect">
                <option>Loading Providers...</option>
              </select>
            </div>
            <div class="control-sub" style="margin-top:5px;">
              Switch if a video fails to load. 'VidSrc.to' is usually fastest.
            </div>
          </div>

          <div class="setting-group">
            <div class="input-label">Default Resolution</div>
            <div class="select-wrapper">
              <!-- Added ID -->
              <select class="cyber-select" id="settingResolution">
                <option>Auto (Recommended)</option>
                <option>4K Ultra HD</option>
                <option>1080p Full HD</option>
                <option>720p Data Saver</option>
              </select>
            </div>
          </div>
        </div>

        <!-- TAB: AUDIO & SUBTITLES -->
        <div id="set-audio" class="set-panel">
          <h2 class="panel-title">Audio & Subtitles</h2>

          <!-- 1. PREFERRED LANGUAGE -->
          <div class="setting-group">
            <div class="input-label">Preferred Subtitle Language</div>
            <div class="select-wrapper">
              <select class="cyber-select" id="settingSubLang" onchange="player.syncSettings()">
                <option value="">Default (Provider Choice)</option>
                <option value="en">English</option>
                <option value="es">Spanish (Español)</option>
                <option value="fr">French (Français)</option>
                <option value="de">German (Deutsch)</option>
                <option value="it">Italian (Italiano)</option>
                <option value="pt">Portuguese (Português)</option>
                <option value="ru">Russian (Pусский)</option>
                <option value="ar">Arabic (العربية)</option>
                <option value="hi">Hindi (हिन्दी)</option>
                <option value="ja">Japanese (日本語)</option>
                <option value="ko">Korean (한국어)</option>
              </select>
            </div>
            <div class="control-sub" style="margin-top:5px;">
              Note: Applied automatically if supported by the source.
            </div>
          </div>

          <!-- 2. SUBTITLE SIZE (Done via Zoom) -->
          <div class="setting-group">
            <div style="display:flex; justify-content:space-between;">
              <div class="input-label">Subtitle Size (Zoom)</div>
              <div class="input-label" id="subSizeVal">1.0x</div>
            </div>
            <input type="range" id="settingSubSize" min="1" max="1.3" step="0.05" value="1" class="cyber-range"
              oninput="document.getElementById('subSizeVal').innerText = this.value + 'x'; player.syncSettings();">
          </div>

          <!-- 3. SUBTITLE TINT (The 'Aether' Hack) -->
          <div class="setting-group">
            <div class="input-label">Subtitle/Scene Tint</div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <!-- White (Default) -->
              <div class="color-swatch active" style="background:#fff;" onclick="player.setTint('none', this)"></div>
              <!-- Yellow -->
              <div class="color-swatch" style="background:#ffd700;" onclick="player.setTint('#ffd700', this)"></div>
              <!-- Cyan -->
              <div class="color-swatch" style="background:#00ffff;" onclick="player.setTint('#00ffff', this)"></div>
              <!-- Pink -->
              <div class="color-swatch" style="background:#ff00ff;" onclick="player.setTint('#ff00ff', this)"></div>
            </div>
            <div class="control-sub" style="margin-top:10px;">
              Applies a visual filter to tint white subtitles.
            </div>
          </div>

          <input type="hidden" id="settingSubColor" value="none">
        </div>

        <!-- TAB: SYSTEM -->
        <div id="set-system" class="set-panel">
          <h2 class="panel-title">System & Storage</h2>

          <div class="setting-group">
            <div class="input-label">Cache Storage (1.2 GB Used)</div>
            <div class="storage-bar">
              <div class="storage-fill" style="width: 45%;"></div>
            </div>
          </div>

          <div class="control-row">
            <div class="control-info">
              <div class="control-head">Clear Search History</div>
              <div class="control-sub">Remove locally saved search terms</div>
            </div>
            <button class="btn-small">Clear</button>
          </div>

          <div class="control-row">
            <div class="control-info">
              <div class="control-head">Debug Mode</div>
              <div class="control-sub">Show FPS and API Latency</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>

          <div style="margin-top:50px; text-align:center; opacity:0.3; font-size:12px;">
            AetherStream v2.4.0 (Build 8829)<br>Powered by TMDB API
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- VIEW: ORIGINALS (LEADERBOARD) -->
  <section id="view-originals" class="view-container">
    <div class="grid-header">
      <div class="hero-badge">Most Watched</div>
      <h1 class="grid-title">Aether Originals</h1>
      <p style="color:var(--text-muted); margin-top:10px;">
        The most popular content across the platform, ranked by real-time community views.
      </p>
    </div>

    <div class="media-grid-h" id="originalsGrid"></div>
  </section>

  <!-- VIEW: USER PROFILE -->
  <section id="view-profile" class="view-container">

    <!-- 1. CINEMATIC HEADER (Dynamic) -->
    <div class="profile-banner">
      <div class="banner-img" id="profileCoverImg"></div>
      <div class="banner-gradient"></div>
      <div class="banner-content">
        <div class="profile-avatar-xl">
          <img src="" id="userPageAvatar" alt="User">
        </div>
        <div class="profile-identity">
          <h1 id="userPageName">Traveler</h1>
          <div class="profile-badges">
            <span class="p-badge" id="memberSince">Member since 2025</span>
            <span class="p-badge highlight" id="favGenreBadge">Action Fan</span>
          </div>
        </div>
      </div>
    </div>

    <div class="profile-layout-advanced">

      <!-- 2. MAIN TABS -->
      <div class="profile-main-col" style="grid-column: 1 / -1;">
        <div class="profile-tabs"
          style="display: flex; gap: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 30px; flex-wrap: wrap;">
          <button class="tab-btn active" onclick="app.switchProfileTab('watchlist')"
            style="padding: 10px 20px; cursor: pointer;">My Watchlist</button>
          <button class="tab-btn" onclick="app.switchProfileTab('history')"
            style="padding: 10px 20px; cursor: pointer;">Watch History</button>
          <button class="tab-btn" onclick="app.switchProfileTab('social')"
            style="padding: 10px 20px; cursor: pointer;">Social Network</button>
          <button class="tab-btn" onclick="app.switchProfileTab('analytics')"
            style="padding: 10px 20px; cursor: pointer;">Analytics</button>
        </div>

        <!-- TAB: WATCHLIST -->
        <div id="tab-watchlist" class="profile-tab-content active">
          <div class="grid-header">
            <h1 class="grid-title">My Watchlist</h1>
            <p style="color:#aaa; margin-top:10px;">Your personal library</p>
          </div>
          <div class="media-grid" id="userPageGrid">
          </div>
        </div>

        <!-- TAB: WATCH HISTORY -->
        <div id="tab-history" class="profile-tab-content" style="display:none;">
          <div class="grid-header">
            <h1 class="grid-title">Watch History</h1>
            <p style="color:#aaa; margin-top:10px;">Your personal library</p>
          </div>
          <div class="media-grid" id="userHistoryGrid"></div>
        </div>

        <!-- TAB: SOCIAL NETWORK -->
        <div id="tab-social" class="profile-tab-content" style="display:none;">
          <div class="social-container" style="width: 100%;">
            <!-- JOIN PARTY INPUT (Important) -->
            <div class="join-party-card"
              style="background:var(--surface-2); padding:20px; border-radius:12px; margin-bottom:30px; display:flex; gap:15px; align-items:center; border:1px solid var(--border);">
              <div style="flex:1;">
                <h4 style="margin:0 0 5px 0; color:#fff;">Join a Watch Party</h4>
                <p style="margin:0; font-size:12px; color:gray;">Paste the Session ID from your friend here:</p>
              </div>
              <input type="text" id="joinSessionInput" placeholder="Session ID..."
                style="background:#000; border:1px solid var(--border); color:#fff; padding:10px; border-radius:8px; width:200px;">

              <!-- This button calls the JOIN function -->
              <button class="btn btn-primary"
                onclick="watchPartyUI.join(document.getElementById('joinSessionInput').value)">
                Join Room
              </button>
            </div>
            <!-- Social Tabs -->
            <div class="social-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="social-tab-btn active" onclick="socialUI.switchTab('profile')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-user"></i> My Profile
              </button>
              <button class="social-tab-btn" onclick="socialUI.switchTab('friends')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-users"></i> Friends
              </button>
              <button class="social-tab-btn" onclick="socialUI.switchTab('requests')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-user-plus"></i> Requests <span class="badge" id="requestsBadge">0</span>
              </button>
              <button class="social-tab-btn" onclick="socialUI.switchTab('search')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-search"></i> Find Users
              </button>
              <button class="social-tab-btn" onclick="socialUI.switchTab('followers')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-heart"></i> Followers
              </button>
            </div>

            <!-- Social Content Container -->
            <div class="social-content" style="width: 100%;">

              <!-- MY PROFILE TAB -->
              <div class="social-tab-content active" id="tab-profile" style="display: block;">
                <div class="profile-card-large">
                  <div class="profile-header">
                    <img src="" id="profileAvatar" class="profile-avatar-large" alt="Profile">
                    <div class="profile-info">
                      <h2 id="profileName">Loading...</h2>
                      <p id="profileEmail" class="profile-email">—</p>
                      <div class="profile-stats">
                        <div class="stat">
                          <span class="stat-value" id="statFriends">0</span>
                          <span class="stat-label">Friends</span>
                        </div>
                        <div class="stat">
                          <span class="stat-value" id="statFollowers">0</span>
                          <span class="stat-label">Followers</span>
                        </div>
                        <div class="stat">
                          <span class="stat-value" id="statMovies">0</span>
                          <span class="stat-label">Movies Watched</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="profile-actions">
                    <button class="btn-secondary" onclick="socialUI.editProfile()">
                      <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="btn-secondary" onclick="socialUI.viewStats()">
                      <i class="fas fa-chart-line"></i> View Stats
                    </button>
                  </div>

                  <div class="profile-section">
                    <h3>Bio</h3>
                    <p id="profileBio" class="profile-bio">No bio added yet</p>
                  </div>

                  <div class="profile-section">
                    <h3>Preferences</h3>
                    <div class="preference-item">
                      <label>
                        <input type="checkbox" id="prefPrivate"
                          onchange="socialUI.updatePreference('isPrivate', this.checked)">
                        <span>Private Profile</span>
                      </label>
                    </div>
                    <div class="preference-item">
                      <label>
                        <input type="checkbox" id="prefActivity" checked
                          onchange="socialUI.updatePreference('showActivity', this.checked)">
                        <span>Show My Activity</span>
                      </label>
                    </div>
                    <div class="preference-item">
                      <label>
                        <input type="checkbox" id="prefMessages" checked
                          onchange="socialUI.updatePreference('allowMessages', this.checked)">
                        <span>Allow Friend Requests</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- FRIENDS LIST TAB -->
              <div class="social-tab-content" id="tab-friends" style="display: none;">
                <div class="friends-header">
                  <h3>Your Friends</h3>
                  <span class="friends-count" id="friendsCount">0 friends</span>
                </div>
                <div class="friends-grid" id="friendsList">
                  <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <p>No friends yet. Search for users to add them!</p>
                  </div>
                </div>
              </div>

              <!-- FRIEND REQUESTS TAB -->
              <div class="social-tab-content" id="tab-requests" style="display: none;">
                <div class="requests-header">
                  <h3>Friend Requests</h3>
                </div>
                <div class="requests-list" id="requestsList">
                  <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No pending requests</p>
                  </div>
                </div>
              </div>

              <!-- SEARCH USERS TAB -->
              <div class="social-tab-content" id="tab-search" style="display: none;">
                <div class="search-users-wrapper">
                  <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearchInput" placeholder="Search by name or email..."
                      onkeyup="socialUI.searchUsers(this.value)">
                  </div>
                  <div class="search-results" id="searchUsersList">
                    <div class="empty-state">
                      <i class="fas fa-search"></i>
                      <p>Enter a name or email to search for users</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- FOLLOWERS TAB -->
              <div class="social-tab-content" id="tab-followers" style="display: none;">
                <div class="followers-header">
                  <h3>Your Followers</h3>
                  <span class="followers-count" id="followersCount">0 followers</span>
                </div>
                <div class="followers-grid" id="followersList">
                  <div class="empty-state">
                    <i class="fas fa-user"></i>
                    <p>You have no followers yet</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- TAB: ANALYTICS -->
        <div id="tab-analytics" class="profile-tab-content" style="display:none;">
          <div class="analytics-container" style="width: 100%;">

            <!-- Analytics Tabs -->
            <div class="analytics-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="analytics-tab-btn active" onclick="analyticsUI.switchTab('feed')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-stream"></i> Activity Feed
              </button>
              <button class="analytics-tab-btn" onclick="analyticsUI.switchTab('recommendations')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-star"></i> Recommended
              </button>
              <button class="analytics-tab-btn" onclick="analyticsUI.switchTab('trending')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-fire"></i> Trending
              </button>
              <button class="analytics-tab-btn" onclick="analyticsUI.switchTab('stats')"
                style="padding: 8px 16px; cursor: pointer;">
                <i class="fas fa-chart-bar"></i> My Stats
              </button>
            </div>

            <!-- Analytics Content -->
            <div class="analytics-content" style="width: 100%;">

              <!-- ACTIVITY FEED TAB -->
              <div class="analytics-tab-content active" id="tab-feed" style="display: block;">
                <div class="activity-feed" id="activityFeed">
                  <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No activity yet</p>
                  </div>
                </div>
              </div>

              <!-- RECOMMENDATIONS TAB -->
              <div class="analytics-tab-content" id="tab-recommendations" style="display: none;">
                <div class="recommendations-header">
                  <h3>Recommended For You</h3>
                  <!-- This subtitle will change dynamically via JS -->
                  <p class="subtitle">Based on your viewing history</p>
                </div>
                <!-- The grid where cards will be injected -->
                <div class="recommendations-grid" id="recommendationsList"></div>
              </div>
              <!-- TRENDING TAB (Advanced Leaderboard) -->
              <div class="analytics-tab-content" id="tab-trending" style="display: none;">

                <div class="trending-dashboard">
                  <!-- Header & Filters -->
                  <div class="trending-header-row">
                    <div>
                      <h3>Global Leaderboard</h3>
                      <p class="subtitle">Top content on Aether right now</p>
                    </div>
                    <div class="trend-filters">
                      <button class="filter-pill active" onclick="analyticsUI.filterTrending('week')">This Week</button>
                      <button class="filter-pill" onclick="analyticsUI.filterTrending('day')">Today</button>
                    </div>
                  </div>

                  <!-- 1. THE PODIUM (Top 3) -->
                  <div class="trending-podium" id="trendingPodium">
                    <!-- Injected via JS -->
                  </div>

                  <!-- 2. THE LIST (Ranks 4-10) -->
                  <div class="trending-list-container">
                    <div class="list-header">
                      <span>Rank</span>
                      <span>Title</span>
                      <span style="text-align:right">Views</span>
                      <span style="text-align:center">Trend</span>
                      <span>Action</span>
                    </div>
                    <div id="trendingListItems">
                      <!-- Injected via JS -->
                    </div>
                  </div>

                </div>
              </div>

              <!-- STATS TAB -->
              <div class="analytics-tab-content" id="tab-stats" style="display: none;">
                <div class="stats-dashboard">
                  <!-- STAT CARDS -->
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-play"></i></div>
                      <h4>Total Watched</h4>
                      <p class="stat-number" id="statTotalWatched">0</p>
                      <p class="stat-unit">movies</p>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-clock"></i></div>
                      <h4>Watch Time</h4>
                      <p class="stat-number" id="statWatchTime">0</p>
                      <p class="stat-unit">hours</p>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-star"></i></div>
                      <h4>Average Rating</h4>
                      <p class="stat-number" id="statAvgRating">0.0</p>
                      <p class="stat-unit">/ 5</p>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon"><i class="fas fa-fire"></i></div>
                      <h4>Watch Streak</h4>
                      <p class="stat-number" id="statStreak">0</p>
                      <p class="stat-unit">days</p>
                    </div>
                  </div>

                  <!-- FAVORITE GENRE -->
                  <div class="stats-section">
                    <h3>Your Favorite Genre</h3>
                    <div class="genre-display" id="favoriteGenre">
                      <p>—</p>
                    </div>
                  </div>

                  <!-- RECENT MOVIES -->
                  <div class="stats-section">
                    <h3>Recently Watched</h3>
                    <div class="recent-movies" id="recentMovies">
                      <div class="empty-state">
                        <p>No movies watched yet</p>
                      </div>
                    </div>
                  </div>

                  <!-- RATINGS SUMMARY -->
                  <div class="stats-section">
                    <h3>Ratings Summary</h3>
                    <div class="ratings-summary" id="ratingsSummary">
                      <div class="rating-item">
                        <span>5 Stars</span>
                        <div class="rating-bar">
                          <div class="rating-fill" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span>4 Stars</span>
                        <div class="rating-bar">
                          <div class="rating-fill" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span>3 Stars</span>
                        <div class="rating-bar">
                          <div class="rating-fill" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span>2 Stars</span>
                        <div class="rating-bar">
                          <div class="rating-fill" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="rating-item">
                        <span>1 Star</span>
                        <div class="rating-bar">
                          <div class="rating-fill" style="width: 0%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
  </section>

  <!-- ============================================
     VIEW: WATCH PARTY (Theater & Chat)
     ============================================ -->
  <!-- VIEW: WATCH PARTY (Theater Mode) -->
  <section id="view-watch-party" class="view-container" style="padding-top: 0;">
    <div class="watch-party-container">

      <!-- LEFT: THEATER AREA -->
      <div class="watch-party-main">

        <!-- 1. Theater Header -->
        <div class="theater-header">
          <button class="btn-icon-text" onclick="watchPartyUI.closeSession()">
            <i class="fas fa-arrow-left"></i> <span>Exit Party</span>
          </button>

          <div style="text-align:center;">
            <div class="theater-title" id="sessionMovieTitle">Loading...</div>
            <div id="sessionMovieInfo" style="font-size:11px; color:#888;">Connecting...</div>
          </div>

          <div class="theater-status">
            <span class="status-dot" id="liveIndicator"></span> Live
          </div>
        </div>

        <!-- 2. Video Player Area -->
        <div class="video-player-wrapper">
          <div id="watchPartyVideo" class="watch-party-video">
            <div class="placeholder-screen">
              <i class="fas fa-film"></i>
              <p>Waiting for video source...</p>
            </div>
          </div>
        </div>

        <!-- 3. Sync Controls Bar -->
        <div class="sync-controls-bar">

          <!-- LEFT: Controls -->
          <div class="controls-left" style="display:flex; align-items:center; gap:15px;">
            <button class="btn-sync" id="playPauseBtn" onclick="watchPartyUI.togglePlayPause()">
              <i class="fas fa-play"></i>
            </button>

            <!-- TV Episode Controls (Hidden by default, shown by JS if TV) -->
            <div id="partyEpControls" style="display:none; gap:8px;">
              <button class="btn-small" onclick="watchPartyUI.changeEpisode(-1)" title="Prev Ep">
                <i class="fas fa-step-backward"></i>
              </button>
              <button class="btn-small" onclick="watchPartyUI.changeEpisode(1)" title="Next Ep">
                <i class="fas fa-step-forward"></i>
              </button>
            </div>
          </div>

          <!-- CENTER: Status -->
          <div class="controls-center">
            <span class="label">Status:</span>
            <strong id="syncStatusText" style="color:#fbbf24">Paused</strong>
          </div>

          <!-- RIGHT: Source -->
          <div class="controls-right" style="display:flex; align-items:center; gap:10px;">
            <button class="btn-small" onclick="watchPartyUI.switchProvider()"
              style="font-size:10px; border-color:#444; color:#aaa;">
              <i class="fas fa-server"></i> Switch Source
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT: SOCIAL SIDEBAR -->
      <aside class="watch-party-sidebar">

        <!-- 1. TABS HEADER -->
        <div class="sidebar-tabs">
          <!-- Chat Tab -->
          <div class="sb-tab active" onclick="watchPartyUI.switchSidebarTab('chat')">
            Chat
          </div>

          <!-- Episodes Tab (Hidden by default, JS shows it for TV) -->
          <div class="sb-tab" id="tabBtnQueue" onclick="watchPartyUI.switchSidebarTab('queue')">
            Episodes
          </div>

          <!-- Viewers Tab -->
          <div class="sb-tab" onclick="watchPartyUI.switchSidebarTab('participants')">
            Users (<span id="syncCount">1</span>)
          </div>
        </div>

        <!-- 2. CHAT PANEL -->
        <div id="partyTabChat" class="sidebar-content-panel" style="display:flex;">
          <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
              <div class="chat-system-msg">Session started. Invite friends!</div>
            </div>
          </div>
          <div class="chat-input-box">
            <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off"
              onkeypress="if(event.key==='Enter') watchPartyUI.sendChatMessage()">
            <button class="chat-send" onclick="watchPartyUI.sendChatMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>

        <!-- 3. EPISODES / QUEUE PANEL (The Missing Part) -->
        <div id="partyTabQueue" class="sidebar-content-panel" style="display:none;">
          <div style="padding:15px; border-bottom:1px solid var(--border);">
            <h3 class="section-title" id="queueTitle" style="margin:0;">Season 1</h3>
          </div>
          <div class="queue-list" id="partyQueueList">
            <!-- Javascript will inject .queue-item divs here -->
            <div style="padding:20px; text-align:center; color:gray;">Loading episodes...</div>
          </div>
        </div>

        <!-- 4. PARTICIPANTS PANEL -->
        <div id="partyTabParticipants" class="sidebar-content-panel" style="display:none;">
          <div class="sidebar-section">
            <h3 class="section-title">Online Users</h3>
            <div class="participants-list" id="participantsList"></div>
          </div>

          <!-- Invite Footer -->
          <div class="sidebar-footer">
            <div class="invite-row">
              <input type="text" id="sessionIdDisplay" readonly value="..." style="width:100%;">
              <button onclick="watchPartyUI.copySessionId()"><i class="fas fa-copy"></i></button>
            </div>
          </div>
        </div>

      </aside>

    </div>
  </section>


  <!-- VIEW: CONSTELLATION (Visual Discovery) -->
  <section id="view-constellation" class="view-container">
    <div class="constellation-ui">
      <div class="constellation-header">
        <h1 class="hero-title">Cinema Constellation</h1>
        <p>Traverse the connections between stories.</p>
      </div>

      <!-- Controls -->
      <div class="constellation-controls">
        <button class="btn-icon magnetic" onclick="constellationUI.resetZoom()"><i
            class="fas fa-compress-arrows-alt"></i></button>
      </div>
    </div>

    <!-- The Universe Container -->
    <div id="universeStage" class="universe-stage">
      <!-- SVG Layer for connecting lines -->
      <svg id="connectionLines" class="connection-lines"></svg>
      <!-- Nodes will be injected here -->
      <div id="nodesContainer"></div>
    </div>

    <!-- Info Panel (Appears on Hover) -->
    <div id="nodeInfoPanel" class="node-info-panel">
      <h3 id="nodeTitle">Title</h3>
      <div id="nodeReason" class="node-reason">Connection</div>
      <div class="node-meta">
        <span id="nodeYear">2024</span> • <span id="nodeRating">8.5</span>
      </div>
    </div>
  </section>

  <!-- MISSION CONTROL OVERLAY -->
  <div id="missionOverlay" class="view-container">
    <div class="mission-header">
      <div class="level-circle">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" class="bg"></circle>
          <circle cx="50" cy="50" r="45" class="progress" id="userLevelCircle"></circle>
        </svg>
        <span id="userLevelDisplay">LVL 1</span>
      </div>

      <div class="xp-details">
        <h2 id="xpTitle">Traveler</h2>
        <div class="xp-bar-container">
          <div class="xp-bar-fill" id="userXpBar"></div>
        </div>
        <p id="xpText">0 / 1000 XP to next level</p>
      </div>

      <div class="streak-badge">
        <i class="fas fa-fire"></i> <span id="userStreak">0</span> Day Streak
      </div>

      <button class="close-btn" onclick="missionUI.close()">✕</button>
    </div>

    <div class="mission-layout">
      <!-- DAILY QUESTS -->
      <div class="quest-section">
        <h3><i class="fas fa-calendar-day"></i> Daily Bounties</h3>
        <div id="dailyQuestsList" class="quest-grid"></div>
      </div>

      <!-- LIFETIME ACHIEVEMENTS -->
      <div class="quest-section">
        <h3><i class="fas fa-trophy"></i> Achievements</h3>
        <div id="achievementsList" class="achievement-grid"></div>
      </div>
    </div>
  </div>

  <!-- VIEW: AUTH / LOGIN --->
  <section id="view-auth" style="
    position: fixed; inset: 0; z-index: 9999; background: var(--bg); 
    display: flex; align-items: center; justify-content: center;
    transition: var(--theme-transition);
    ">

    <div class="auth-card" style="
      width: 100%; max-width: 400px; padding: 40px; 
      background: var(--surface-glass); backdrop-filter: blur(20px);
      border: 1px solid var(--border); border-radius: 20px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.5); position: relative; overflow: hidden;
    ">

      <div
        style="position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: var(--accent); filter: blur(80px); opacity: 0.4; border-radius: 50%;">
      </div>

      <div style="text-align: center; margin-bottom: 30px; position: relative; z-index: 2;">
        <div class="brand" style="justify-content: center; margin-bottom: 10px;">AETHER<span>.</span></div>
        <p style="color: var(--text-muted); font-size: 14px;">Welcome back to the ultimate stream.</p>
      </div>

      <div id="authError"
        style="color: #ff4444; font-size: 13px; text-align: center; margin-bottom: 15px; display: none;">Error message
        here</div>

      <div class="setting-group">
        <div class="input-label">Email</div>
        <input type="email" id="authEmail" class="cyber-input" placeholder="user@example.com">
      </div>

      <div class="setting-group">
        <div class="input-label">Password</div>
        <input type="password" id="authPass" class="cyber-input" placeholder="••••••••">
      </div>

      <div id="btnContainerLogin">
        <button class="btn btn-primary" onclick="app.handleLogin()"
          style="width: 100%; justify-content: center; margin-bottom: 15px;">
          Enter Aether
        </button>
        <div style="text-align: center; font-size: 12px; color: var(--text-muted); cursor: pointer;"
          onclick="app.toggleAuthMode('signup')">
          New here? <span style="color: var(--text); font-weight: 700;">Create Account</span>
        </div>
      </div>

      <div id="btnContainerSignup" style="display: none;">
        <div class="setting-group">
          <div class="input-label">Display Name</div>
          <input type="text" id="authName" class="cyber-input" placeholder="Traveler">
        </div>
        <button class="btn btn-primary" onclick="app.handleRegister()"
          style="width: 100%; justify-content: center; margin-bottom: 15px;">
          Initialize Account
        </button>
        <div style="text-align: center; font-size: 12px; color: var(--text-muted); cursor: pointer;"
          onclick="app.toggleAuthMode('login')">
          Already have access? <span style="color: var(--text); font-weight: 700;">Sign In</span>
        </div>
      </div>

      <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
        <button class="btn btn-blur" onclick="app.handleGoogleLogin()"
          style="width: 100%; justify-content: center; font-size: 13px;">
          <i class="fab fa-google"></i> Continue with Google
        </button>
      </div>

    </div>
  </section>

  <div class="stream-modal" id="streamModal">

    <!-- HEADER (Top Bar) -->
    <div class="stream-header" id="streamHeader">
      <div style="display:flex; align-items:center; gap:15px;">
        <div class="close-icon-circle" onclick="player.close()" style="background:rgba(255,255,255,0.1);">
          <i class="fas fa-arrow-left"></i>
        </div>
        <div>
          <div class="stream-title" id="streamTitle">Loading Title...</div>
          <div id="streamSourceLabel" class="stream-meta" style="margin:0; font-size:11px; opacity:0.7;">Source: ...
          </div>
        </div>
      </div>

      <div style="display:flex; align-items:center; gap:10px;">
        <!-- SETTINGS TRIGGER (Inside Player) -->
        <div class="control-btn" onclick="player.openSettings()">
          <i class="fas fa-cog"></i>
        </div>
      </div>
    </div>

    <!-- PLAYER CONTENT -->
    <div class="stream-content" id="streamContentArea">

      <!-- LOADER -->
      <div class="stream-loader" id="streamLoader">
        <svg viewBox="0 0 50 50" class="spinner">
          <circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
        </svg>
      </div>

      <!-- TINT OVERLAY -->
      <div id="streamTintLayer"
        style="position: absolute; inset: 0; pointer-events: none; z-index: 5; transition: background-color 0.3s;">
      </div>

      <!-- IFRAME -->
      <iframe id="streamFrame" class="stream-frame" allowfullscreen allow="autoplay; encrypted-media; fullscreen"
        style="border:none; opacity:0; transition: transform 0.3s;"></iframe>

      <!-- OVERLAY CONTROLS (Middle & Bottom) -->
      <div class="stream-controls-layer" id="streamControls">

        <!-- Middle: Prev / Next Buttons -->
        <div class="nav-controls">
          <button class="nav-btn" id="btnPrevEp" onclick="player.prevEpisode()">
            <i class="fas fa-step-backward"></i>
          </button>

          <!-- Refresh Button (Center) -->
          <button class="nav-btn refresh-btn" onclick="player.refreshStream()" title="Reload Stream">
            <i class="fas fa-redo-alt"></i>
          </button>

          <button class="nav-btn" id="btnNextEp" onclick="player.nextEpisode()">
            <i class="fas fa-step-forward"></i>
          </button>
        </div>

        <!-- Bottom: Info -->
        <div class="bottom-info">
          <div id="episodeNameLabel" style="font-size:14px; font-weight:600; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ACTOR MODAL -->
  <div class="video-modal" id="actorModal" style="z-index: 7000;">
    <div class="modal-bg" onclick="actorUI.close()"></div>

    <div class="auth-card actor-card"
      style="width:900px; max-width:95%; height:80vh; padding:0; background:#000; display:flex; flex-direction:column; overflow:hidden;">

      <!-- Header / Close -->
      <div style="position:absolute; top:20px; right:20px; z-index:10;">
        <div class="close-icon-circle" onclick="actorUI.close()"><i class="fas fa-times"></i></div>
      </div>

      <div class="actor-layout">
        <!-- Left: Image -->
        <div class="actor-sidebar">
          <img id="actorImage" src="" alt="Actor">
        </div>

        <!-- Right: Info -->
        <div class="actor-details-panel">
          <h2 id="actorName">Name</h2>
          <div id="actorMeta" style="color:var(--text-muted); font-size:12px; margin-bottom:15px;"></div>

          <!-- Affinity Badge -->
          <div id="affinityBadge"
            style="display:none; background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:6px; font-size:12px; margin-bottom:20px; border:1px solid var(--border);">
          </div>

          <p id="actorBio"
            style="font-size:14px; color:#ccc; line-height:1.6; max-height:100px; overflow-y:auto; margin-bottom:30px; padding-right:10px;">
          </p>

          <h3
            style="font-size:14px; text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
            Known For</h3>

          <div class="recommendations-grid" id="actorCredits"
            style="overflow-y:auto; padding-bottom:50px; max-height:400px;"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================
     COMPONENT TEMPLATES
     ============================================ -->

  <!-- FRIEND CARD TEMPLATE -->
  <template id="friendCardTemplate">
    <div class="friend-card"
      style="background:var(--surface-2); padding:15px; border-radius:12px; text-align:center; border:1px solid var(--border);">
      <img src="" class="friend-avatar"
        style="width:60px; height:60px; border-radius:50%; object-fit:cover; margin-bottom:10px;">
      <h4 class="friend-name" style="margin:0; font-size:14px;">Name</h4>
      <p class="friend-status" style="font-size:11px; color:#10b981; margin-bottom:10px;">Online</p>
      <div class="friend-actions" style="display:flex; justify-content:center; gap:10px;">
        <button class="btn-small danger" style="color:#ff4444; border-color:#ff4444;">Remove</button>
      </div>
    </div>
  </template>

  <!-- FRIEND REQUEST CARD TEMPLATE -->
  <template id="requestCardTemplate">
    <div class="request-card"
      style="display:flex; align-items:center; gap:15px; padding:15px; background:var(--surface-2); border-radius:12px; margin-bottom:10px;">
      <img src="" class="request-avatar" style="width:40px; height:40px; border-radius:50%;">
      <div style="flex:1;">
        <h4 class="request-name" style="font-size:14px; margin:0;">Name</h4>
        <p class="request-time" style="font-size:11px; color:gray;">Sent a request</p>
      </div>
      <div class="request-actions" style="display:flex; gap:5px;">
        <button class="btn-small accept" style="color:#10b981; border-color:#10b981;"><i
            class="fas fa-check"></i></button>
        <button class="btn-small reject" style="color:#ff4444; border-color:#ff4444;"><i
            class="fas fa-times"></i></button>
      </div>
    </div>
  </template>


  <!-- ACTIVITY ITEM TEMPLATE -->
  <template id="activityItemTemplate">
    <div class="activity-item" style="display:flex; gap:15px; padding:15px; border-bottom:1px solid var(--border);">
      <img src="" class="activity-avatar" style="width:40px; height:40px; border-radius:50%;">
      <div class="activity-content">
        <p class="activity-text" style="font-size:13px; margin:0;">
          <strong class="activity-user">User</strong> <span class="activity-action">watched</span> <strong
            class="activity-movie" style="color:var(--accent)">Movie</strong>
        </p>
        <p class="activity-time" style="font-size:11px; color:gray; margin-top:4px;">Just now</p>
      </div>
      <div class="activity-rating"></div>
    </div>
  </template>

  <!-- MOVIE CARD TEMPLATE -->
  <template id="movieCardTemplate">
    <div class="movie-card-small">
      <img src="" class="movie-poster-small" alt="Movie">
      <h4 class="movie-title-small">Title</h4>
      <p class="movie-rating-small">
        <i class="fas fa-star"></i> 0.0
      </p>
      <button class="btn-small" onclick="watchPartyUI.watchMovie(this)">
        <i class="fas fa-play"></i> Watch
      </button>
    </div>
  </template>

  <!-- SEARCH USER RESULT TEMPLATE -->
  <template id="searchResultTemplate">
    <div class="search-result-item">
      <img src="" class="result-avatar" alt="User">
      <div class="result-info">
        <h4 class="result-name">Name</h4>
        <p class="result-email">email@example.com</p>
      </div>
      <!-- Button logic handled by JS -->
      <button class="btn-primary" id="actionBtn">Add</button>
    </div>
  </template>

  <!-- ORACLE MODAL -->
  <div class="oracle-modal" id="oracleModal">
    <div class="modal-bg" onclick="oracleUI.close()"></div>
    <div class="oracle-content">

      <!-- INPUT STATE -->
      <div id="oracleInputs">
        <div class="oracle-header">
          <i class="fas fa-crystal-ball"></i>
          <h2>The Oracle</h2>
          <p>How are you feeling right now?</p>
        </div>
        <div class="oracle-tags" id="oracleTags"></div>
        <div class="oracle-action" id="oracleActionArea">
          <button class="btn btn-primary" onclick="oracleUI.generatePicks()">Reveal My Destiny</button>
        </div>
      </div>

      <!-- LOADING STATE -->
      <div class="oracle-loader" id="oracleLoader">
        <div class="spinner">
          <circle cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
        </div>
        <p>Consulting the Aether...</p>
      </div>

      <!-- RESULTS STATE -->
      <div class="oracle-results" id="oracleResults"></div>

      <div class="oracle-footer" style="text-align:center;"></div>
    </div>
  </div>

  <!-- AETHER LENS OVERLAY -->
  <div id="lensOverlay" class="lens-overlay">
    <div class="lens-scan-line" id="lensScanLine"></div>

    <button class="lens-close" onclick="window.lensUI.toggle()"><i class="fas fa-times"></i></button>

    <div class="lens-grid">

      <!-- 1. Color Analysis -->
      <div class="lens-widget">
        <div class="widget-title">Chromatic Analysis</div>
        <div class="palette-container" id="lensPalette"></div>
        <p style="margin-top:10px; font-size:12px; color:#888;">Dominant mood colors extracted from film imagery.</p>
      </div>

      <!-- 2. Sonic Signature -->
      <div class="lens-widget">
        <div class="widget-title">Sonic Signature</div>
        <div class="audio-visualizer">
          <div class="av-bar" style="animation-delay:0.1s"></div>
          <div class="av-bar" style="animation-delay:0.3s"></div>
          <div class="av-bar" style="animation-delay:0.5s"></div>
          <div class="av-bar" style="animation-delay:0.2s"></div>
          <div class="av-bar" style="animation-delay:0.4s"></div>
        </div>
        <h3 id="lensMusicText" style="color:#fff; font-size:16px;">Soundtrack</h3>
        <a id="lensMusicLink" href="#" target="_blank" class="btn-link" style="color:var(--accent);">
          <i class="fab fa-spotify"></i> Listen on Spotify
        </a>
      </div>

      <!-- 3. Temporal Context -->
      <div class="lens-widget">
        <div class="widget-title">Temporal Context</div>
        <h2 style="font-family:'Playfair Display'; font-size:2rem; margin:0 0 10px; color:#fff;">Time Capsule</h2>
        <p id="lensYearFact" style="font-size:14px; color:#ccc; line-height:1.5;">...</p>
      </div>

      <!-- 4. Vibe/Keywords -->
      <div class="lens-widget">
        <div class="widget-title">Narrative DNA</div>
        <div class="lens-tags" id="lensKeywords"></div>
      </div>

    </div>
  </div>

  <!-- SECURITY BREACH MODAL -->
  <div id="securityModal" class="security-overlay">
    <div class="security-box">
      <div class="security-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h1 class="security-title">RESTRICTED CONTENT DETECTED</h1>
      <p class="security-msg">
        This search query violates the Aether Safety Protocols.
        <br><br>
        <span style="color: #ff4444; font-weight: 700;">ACTIVITY HAS BEEN FLAGGED.</span>
      </p>
      <div class="security-actions">
        <button class="btn-security" onclick="app.closeSecurityModal()">I Understand</button>
      </div>
    </div>
  </div>

  <script type="module">
    // 1. IMPORT FIREBASE MODULES
    import { loginEmail, registerEmail, loginGoogle, logoutUser, initAuthObserver } from "./js/firebase/auth.js";
    import {
      addToCloudList, removeFromCloudList, getUserData, saveUserSettings, trackGlobalView, getGlobalRankings,
      trackHistory, addFavorite, removeFavorite, rateMediaUser, getUserRating
    } from "./js/firebase/db.js";
    import { updateUserProfile } from "./js/firebase/social.js";
    import { getAuth, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { player } from "./js/player/engine.js";

    // 2. IMPORT UI CONTROLLERS
    import { SocialUIController } from "./js/ui/social-ui.js";
    import { AnalyticsUIController } from "./js/ui/analytics-ui.js";
    import { WatchPartyUIController } from "./js/ui/watch-party-ui.js";
    import { OracleUIController } from "./js/ui/oracle-ui.js";
    import { ActorUIController } from "./js/ui/actor-ui.js";
    import { ConstellationUIController } from "./js/ui/constellation-ui.js"; // Or define inlineML
    import { ProfileGateUI } from "./js/ui/profile-gate-ui.js";
    import { LensUIController } from "./js/ui/lens-ui.js";

    import { ChallengeEngine } from "./js/gamification/ChallengeEngine.js"; // You need this file (from previous prompt)
    import "./js/ui/mission-ui.js"; // This loads your UI class

    // Initialize UI Controllers globally
    const socialUI = new SocialUIController();
    const analyticsUI = new AnalyticsUIController();
    const watchPartyUI = new WatchPartyUIController();
    const oracleUI = new OracleUIController();
    const actorUI = new ActorUIController();
    const constellationUI = new ConstellationUIController();
    window.constellationUI = constellationUI; // Expose to HT
    const lensUI = new LensUIController();
    window.lensUI = lensUI;

    const profileGateUI = new ProfileGateUI();
    gsap.registerPlugin(ScrollTrigger);
    // Expose player to window so HTML onclicks work
    window.player = player;
    window.profileGateUI = profileGateUI;
    /**
     * AETHER STREAM - ULTIMATE EDITION
     * Integrated with Firebase Auth
     */
    const API_KEY = '31280d77499208623732d77823eabcb4';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMG_BASE = 'https://image.tmdb.org/t/p/original';
    const POSTER_BASE = 'https://image.tmdb.org/t/p/w500';
    const LOGO_BASE = 'https://image.tmdb.org/t/p/w300';
    const GENRE_MAP = { 28: 10759, 12: 10759, 35: 35, 80: 80, 18: 18, 14: 10765, 27: 9648, 878: 10765, 53: 9648 };

    const api = {
      // Read directly from storage to ensure it updates immediately on profile switch
      get isKids() {
        return localStorage.getItem('aether_is_kids') === 'true';
      },
      get: async (endpoint, params = {}) => {
        // 1. Base Parameters
        let queryParams = {
          api_key: API_KEY,
          language: 'en-US',
          include_adult: 'false', // HARD LOCK: Never allow explicit adult flag
          ...params
        };

        // 2. KIDS MODE FORCE FIELD
        if (api.isKids) {

          // A. Strict Certifications (US Ratings: G, PG only. Excludes PG-13, R, NC-17)
          // Only apply this to lists/discover/search, not specific IDs
          if (endpoint.includes('discover') || endpoint.includes('search')) {
            queryParams.certification_country = "US";
            queryParams.certification_lte = "PG";

            // B. Ban Specific Genres (Horror, Crime, War, Thriller)
            // 27=Horror, 80=Crime, 53=Thriller, 10752=War, 18=Drama(optional, usually boring for kids)
            queryParams.without_genres = "27,80,10752,53";

            // C. Force Animation/Family priority (Optional but recommended)
            // If it's a generic discover call, boost these
            if (!queryParams.with_genres && endpoint.includes('discover')) {
              // queryParams.with_genres = "16,10751"; // Animation, Family
            }
          }
        }

        const query = new URLSearchParams(queryParams).toString();

        try {
          const res = await fetch(`${BASE_URL}${endpoint}?${query}`);
          if (!res.ok) return null;
          const data = await res.json();

          // 3. CLIENT-SIDE SAFETY NET (Double Check)
          // Sometimes API slips up. We manually filter the results array if it exists.
          if (api.isKids && data.results && Array.isArray(data.results)) {
            data.results = data.results.filter(m => {
              // A. Genre Filter (Existing)
              const badGenres = [27, 80, 53, 10752];
              if (m.genre_ids && m.genre_ids.some(g => badGenres.includes(g))) return false;
              if (m.adult) return false;

              // B. TITLE & DESCRIPTION SCANNER (New!)
              // Check if the Movie Title or Description contains a restricted word
              const textToCheck = (m.title || m.name || "") + " " + (m.overview || "");

              // Use the RESTRICTED_TERMS list we defined earlier
              const hasBadWord = RESTRICTED_TERMS.some(pattern => pattern.test(textToCheck));

              if (hasBadWord) {
                console.log("Blocked content by title/desc:", m.title);
                return false; // Remove this specific movie from results
              }

              return true;
            });
          }

          return data;

        } catch (e) {
          console.error('API Error:', e);
          return null;
        }
      },
      /*
      findVideo: async (id, type) => {
        const endpoint = type === 'tv' ? `/tv/${id}/videos` : `/movie/${id}/videos`;
        const data = await api.get(endpoint);
        if (data && data.results) {
          const trailer = data.results.find(v => v.type === 'Trailer') || data.results[0];
          return trailer ? trailer.key : null;
        }
        return null;
      }*/

      findVideo: async (id, type) => {
        const endpoint = type === 'tv' ? `/tv/${id}/videos` : `/movie/${id}/videos`;
        const data = await api.get(endpoint);
        if (data && data.results) {
          // Prefer "Trailer" or "Teaser"
          const trailer = data.results.find(v => v.type === 'Trailer') || data.results[0];
          return trailer ? trailer.key : null;
        }
        return null;
      }
    };

    window.api = api;

    const anim = {
      initMagnetic: () => {
        document.querySelectorAll('.magnetic').forEach(btn => {
          btn.addEventListener('mousemove', (e) => {
            const r = btn.getBoundingClientRect();
            const x = e.clientX - r.left - r.width / 2;
            const y = e.clientY - r.top - r.height / 2;
            gsap.to(btn, { x: x * 0.3, y: y * 0.3, duration: 0.3, ease: 'power2.out' });
          });
          btn.addEventListener('mouseleave', () => {
            gsap.to(btn, { x: 0, y: 0, duration: 0.5, ease: 'elastic.out(1,0.5)' });
          });
        });
      },
      pageTrans: (viewId) => {
        const view = document.getElementById(viewId);
        gsap.fromTo(view, { opacity: 0, y: 30 }, { opacity: 1, y: 0, duration: 0.6, ease: 'power3.out', delay: 0.2 });
      }
    };

    const ui = {
      /*card: (m, forcedType = null) => {
        if (!m.poster_path) return null;
        const div = document.createElement('div');
        div.className = 'card gpu';
        const title = m.title || m.name;
        const type = m.media_type || forcedType || (m.title ? 'movie' : 'tv');
        let label = m.media_type ? `<div class="card-label">${type === 'tv' ? 'TV Series' : 'Movie'}</div>` : '';
        div.innerHTML = `${label}<img src="${POSTER_BASE}${m.poster_path}" loading="lazy" alt="${title}">`;
        div.onclick = () => app.go('detail', { id: m.id, type: type });
        return div;
      },*/
      card: (m, forcedType = null) => {
        const div = document.createElement('div');
        div.className = 'card gpu';
        const title = m.title || m.name || 'Untitled';
        const type = m.media_type || forcedType || (m.title ? 'movie' : 'tv');

        // LOGIC TO HANDLE MISSING IMAGES
        let imgSrc;
        if (m.poster_path) {
          imgSrc = `https://image.tmdb.org/t/p/w500${m.poster_path}`;
        } else {
          // Fallback image
          imgSrc = 'https://via.placeholder.com/500x750/111/333?text=No+Image';
        }

        let label = `<div class="card-label">${type === 'tv' ? 'TV' : 'Movie'}</div>`;

        div.innerHTML = `${label}<img src="${imgSrc}" loading="lazy" alt="${title}">`;
        div.onclick = () => app.go('detail', { id: m.id, type: type });
        return div;
      },
      row: (title, items, containerId, type = 'movie') => {
        if (!items || !items.length) return;
        const s = document.createElement('section');
        s.className = 'row';
        s.innerHTML = `<div class="row-head"><div class="row-title">${title}</div></div><div class="scroll-container"><div class="scroll-content"></div></div>`;
        const sc = s.querySelector('.scroll-content');
        items.forEach(m => { const c = ui.card(m, type); if (c) sc.appendChild(c); });
        document.getElementById(containerId).appendChild(s);
        gsap.to(s, { opacity: 1, y: 0, duration: 0.8, ease: 'power2.out', scrollTrigger: { trigger: s, start: 'top 90%' } });
        app.enableDrag(sc);
      }
    };


    /* Add inside your script tag */
    const initSpotlightAnimation = () => {
      const section = document.querySelector('.spotlight-section');
      const leftCol = document.querySelector('.spotlight-col-left');
      const rightCol = document.querySelector('.spotlight-col-right');
      const poster = document.querySelector('.poster-frame');
      const textItems = document.querySelectorAll('.spotlight-title, .spotlight-genre, .spotlight-actions-left');

      // 1. Fade in the whole block
      gsap.to(section, {
        opacity: 1,
        y: 0,
        duration: 1,
        ease: "power3.out",
        scrollTrigger: {
          trigger: section,
          start: "top 85%"
        }
      });

      // 2. Inner Elements Stagger
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: "top 70%"
        }
      });

      tl.from(poster, { scale: 0.9, opacity: 0, duration: 0.8, ease: "back.out(1.7)" })
        .from(textItems, { y: 20, opacity: 0, stagger: 0.1, duration: 0.6 }, "-=0.6")
        .from('.spotlight-scene-wrap', { clipPath: "inset(0 100% 0 0)", duration: 1, ease: "power4.out" }, "-=0.8")
        .from('.detail-block', { opacity: 0, y: 20, stagger: 0.2 }, "-=0.5");
    };

    const KIDS_AGE_RATINGS = ['G', 'PG', 'TV-Y', 'TV-G', 'TV-PG', 'TV-Y7', 'TV-Y7-FV'];
    const KIDS_CONTENT_TYPES = ['Animation', 'Family', 'Kids', 'Educational'];

    // SAFETY BLACKLIST (Advanced Regex)
    // Matches "word", "w o r d", "w.o.r.d", "w-o-r-d", etc.
    const RESTRICTED_TERMS = [
      // HENTAI / ANIME (Aggressive Partial Matching)
      // Catch "hent", "henta", "hentai" with any separators
      /h[\W_]*e[\W_]*n[\W_]*t[\W_]*a?[\W_]*i?/i,
      /e[\W_]*c[\W_]*c[\W_]*h[\W_]*i/i,
      /d[\W_]*o[\W_]*u[\W_]*j[\W_]*i[\W_]*n/i,
      /y[\W_]*a[\W_]*o[\W_]*i/i,
      /y[\W_]*u[\W_]*r[\W_]*i/i,
      /t[\W_]*e[\W_]*n[\W_]*t[\W_]*a[\W_]*c[\W_]*l/i,

      //EXPLICIT (Core words)
      // We use \b at the start/end of short words to prevent blocking "Sussex" or "Skill"
      // while still catching "s.e.x"
      /\bs[\W_]*e[\W_]*x\b/i,
      /p[\W_]*o[\W_]*r[\W_]*n/i,
      /x[\W_]*x[\W_]*x/i,
      /n[\W_]*u[\W_]*d/i,
      /e[\W_]*r[\W_]*o[\W_]*t/i,

      //ANATOMY
      /b[\W_]*o[\W_]*o[\W_]*b/i,
      /t[\W_]*i[\W_]*t[\W_]*s/i, // Added 's' to avoid blocking "Title" or "Titan"
      /v[\W_]*a[\W_]*g[\W_]*i[\W_]*n/i,
      /p[\W_]*e[\W_]*n[\W_]*i[\W_]*s/i,
      /c[\W_]*o[\W_]*c[\W_]*k\b/i, // Boundary to avoid "Cocktail" or "Peacock"
      /p[\W_]*u[\W_]*s[\W_]*s[\W_]*y/i,

      //VIOLENCE
      /\bk[\W_]*i[\W_]*l[\W_]*l/i, // Boundary start to avoid "Skill"
      /m[\W_]*u[\W_]*r[\W_]*d[\W_]*e[\W_]*r/i,
      /b[\W_]*l[\W_]*o[\W_]*o[\W_]*d/i,
      /g[\W_]*o[\W_]*r[\W_]*e/i,
      /s[\W_]*u[\W_]*i[\W_]*c[\W_]*i[\W_]*d/i,

      //DRUGS
      /c[\W_]*o[\W_]*c[\W_]*a[\W_]*i[\W_]*n/i,
      /h[\W_]*e[\W_]*r[\W_]*o[\W_]*i[\W_]*n/i,
      /m[\W_]*e[\W_]*t[\W_]*h/i,

      //HORROR / SCARY (Specific to Kids Mode)
      /h[\W_]*o[\W_]*r[\W_]*r[\W_]*o[\W_]*r/i,
      /d[\W_]*e[\W_]*m[\W_]*o[\W_]*n/i,
      /g[\W_]*h[\W_]*o[\W_]*s[\W_]*t/i,
      /s[\W_]*c[\W_]*a[\W_]*r[\W_]*y/i,
      /t[\W_]*e[\W_]*r[\W_]*r[\W_]*o[\W_]*r/i
    ];

    // --- APP DEFINITION ---
    const app = {
      state: {
        user: null, // Stores Firebase User
        menuOpen: false,
        sidebarOpen: false,
        searchOpen: false,
        watchlist: JSON.parse(localStorage.getItem('aether_wl') || '[]'),
        currentMedia: null,
        pages: { movie: 1, tv: 1 },
        currentParams: null,
        allProviders: [],
        visibleProvidersCount: 0
      },

      init: async () => {
        app.initTheme();
        anim.initMagnetic();
        initAvatar(); // Init the avatar physics
        player.init();
        initSpotlightAnimation();
        app.initSpotlightStrokes();
        app.initSidebarFeatures();

        // -- FIREBASE AUTH LISTENER --
        initAuthObserver(
          async (user) => {
            // ==========================================
            // 1. USER LOGGED IN
            // ==========================================
            app.state.user = user;
            app.updateProfileUI(user);

            // ==========================================
            // 2. CHECK: Is a profile already selected?
            // ==========================================
            const activeProfileId = localStorage.getItem('aether_active_profile');

            if (!activeProfileId) {
              // --- A. NO PROFILE SELECTED -> SHOW GATE ---
              console.log("No profile selected. Showing Gate.");

              // Hide App Interface
              document.querySelector('nav').style.display = 'none';
              document.querySelector('main').style.display = 'none';
              document.getElementById('view-auth').style.display = 'none';

              // Show Profile Gate
              const gate = document.getElementById('profileGateView');
              gate.style.display = 'flex'; // Force display CSS
              // Small timeout to allow CSS transition
              setTimeout(() => gate.classList.add('active'), 10);

              // Initialize Gate UI (Load profiles from DB)
              window.profileGateUI.init();

              return; // STOP HERE. Do not load the dashboard yet.
            }

            // Sync Safety Toggle
            const safetyToggle = document.getElementById('settingSafetyFilter');
            if (safetyToggle) {
              safetyToggle.checked = localStorage.getItem('aether_adult_safety') === 'true';
            }

            // ==========================================
            // 3. PROFILE SELECTED -> LOAD DASHBOARD
            // ==========================================
            console.log("Profile active:", activeProfileId);

            // Hide Gate (if visible)
            const gate = document.getElementById('profileGateView');
            gate.classList.remove('active');
            setTimeout(() => gate.style.display = 'none', 300);

            // Show App Interface
            document.querySelector('nav').style.display = 'flex';
            document.querySelector('main').style.display = 'block';

            // Hide Login Screen with Animation
            const authView = document.getElementById('view-auth');
            gsap.to(authView, {
              opacity: 0,
              y: -50,
              duration: 0.8,
              ease: "power4.out",
              onComplete: () => authView.style.display = 'none'
            });

            // ==========================================
            // 4. SYNC CLOUD DATA
            // ==========================================
            try {
              const userData = await getUserData(user);

              // Sync Watchlist
              if (userData && userData.watchlist) {
                app.state.watchlist = userData.watchlist;
                app.renderWatchlist();
                // Update hero buttons if needed
                if (app.state.currentMedia) {
                  const listBtn = document.getElementById('heroListBtn');
                  if (listBtn) app.updateListBtn(listBtn, app.state.currentMedia.id);
                }
              }

              // Sync Theme/Settings
              if (userData && userData.settings && userData.settings.theme) {
                // Apply saved theme
                app.applyTheme(userData.settings.theme);
                // Update toggle switch UI
                const isDark = userData.settings.theme === 'dark';
                const toggle = document.getElementById('themeToggle');
                if (toggle) toggle.checked = isDark;
              }
            } catch (err) {
              console.error("Error syncing user data:", err);
            }

            window.challengeSystem = new ChallengeEngine(user);
            await window.challengeSystem.init();

            // ==========================================
            // 5. LOAD CONTENT (Kids vs Adult)
            // ==========================================
            // Clear existing rows to prevent duplicates if switching profiles
            document.getElementById('homeRows').innerHTML = '';

            const isKids = localStorage.getItem('aether_is_kids') === 'true';

            if (isKids) {
              console.log("Loading Kids Mode Content...");

              // ------------------------------------------
              // 1. HERO + SPOTLIGHT FROM FAMILY MOVIES (Unchanged)
              // ------------------------------------------
              const kidsMovies = await api.get('/discover/movie', {
                with_genres: "16,10751",
                sort_by: "popularity.desc",
                certification_country: "US",
                certification_lte: "PG"
              });

              if (kidsMovies && kidsMovies.results.length) {
                app.renderHero(kidsMovies.results[0]);
                if (kidsMovies.results.length > 1)
                  app.renderSpotlight(kidsMovies.results[1]);
                ui.row('Popular Animation', kidsMovies.results, 'homeRows', 'movie');
              }

              // ------------------------------------------
              // 2. DISNEY SECTION (Updated)
              // ------------------------------------------
              const disney = await api.get('/discover/movie', {
                with_companies: "2,3,2775,6125" // Disney, Pixar, Disney Channel, 20th Animation
              });
              if (disney) ui.row('Disney & Pixar', disney.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 3. DREAMWORKS ANIMATION (Updated)
              // ------------------------------------------
              const dreamworks = await api.get('/discover/movie', {
                with_companies: "521,33" // DreamWorks + Parent Company Universal
              });
              if (dreamworks) ui.row('DreamWorks Hits', dreamworks.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 4. ILLUMINATION ENTERTAINMENT (Unchanged)
              // ------------------------------------------
              const illumination = await api.get('/discover/movie', {
                with_companies: "6704"
              });
              if (illumination) ui.row('Illumination Fun', illumination.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 5. LEGO CONTENT (Unchanged)
              // ------------------------------------------
              const lego = await api.get('/discover/movie', {
                with_keywords: "210024" // LEGO keyword in TMDB
              });
              if (lego) ui.row('LEGO Adventures', lego.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 6. NICKELODEON (Unchanged)
              // ------------------------------------------
              const nick = await api.get('/discover/tv', {
                with_companies: "288" // Nickelodeon
              });
              if (nick) ui.row('Nickelodeon Shows', nick.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 7. CARTOON NETWORK (Updated)
              // ------------------------------------------
              const cn = await api.get('/discover/tv', {
                with_companies: "6869,2503" // Cartoon Network + Cartoon Network Studios
              });
              if (cn) ui.row('Cartoon Network Classics', cn.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 8. EDUCATIONAL CONTENT (Updated with better keywords)
              // ------------------------------------------
              const edu = await api.get('/discover/tv', {
                with_keywords: "9711,10708,209714", // child, children, based on children's book
                certification_country: "US",
                certification_lte: "G"
              });
              if (edu) ui.row('Learn & Explore', edu.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 9. ADVENTURE FOR KIDS (Unchanged)
              // ------------------------------------------
              const adventure = await api.get('/discover/movie', {
                with_genres: "12",
                certification_country: "US",
                certification_lte: "PG"
              });
              if (adventure) ui.row('Adventure for Kids', adventure.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 10. COMEDY FOR KIDS (Unchanged)
              // ------------------------------------------
              const comedy = await api.get('/discover/movie', {
                with_genres: "35",
                certification_country: "US",
                certification_lte: "PG"
              });
              if (comedy) ui.row('Laugh & Smile', comedy.results, 'homeRows', 'movie');

              // ------------------------------------------
              // 11. ANIMATED TV SERIES (Unchanged)
              // ------------------------------------------
              const kidsTv = await api.get('/discover/tv', {
                with_genres: "16,10751",
                sort_by: "popularity.desc",
                certification_country: "US",
                certification_lte: "TV-Y7"
              });
              if (kidsTv) ui.row('Cartoons & Fun', kidsTv.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 12. NATIONAL GEOGRAPHIC (Nature & Science)
              // ------------------------------------------
              const natGeo = await api.get('/discover/tv', {
                with_companies: "16947,7521", // National Geographic Television, Nat Geo Wild
                with_genres: "99", // Documentary
                certification_lte: "TV-PG" // Allow for slightly older kids documentaries
              });
              if (natGeo) ui.row('National Geographic Explore', natGeo.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 13. BBC CHILDREN'S (CBeebies/CBBC)
              // ------------------------------------------
              const bbcKids = await api.get('/discover/tv', {
                with_networks: "26,1130,5780" // BBC (26), CBeebies (1130), CBBC (5780)
              });
              if (bbcKids) ui.row('BBC Kids Shows', bbcKids.results, 'homeRows', 'tv');

              // ------------------------------------------
              // 14. PBS KIDS (Educational US TV)
              // ------------------------------------------
              const pbsKids = await api.get('/discover/tv', {
                with_networks: "32", // PBS (Public Broadcasting Service)
                certification_country: "US",
                certification_lte: "TV-Y" // Focused on the youngest audience
              });
              if (pbsKids) ui.row('PBS Educational', pbsKids.results, 'homeRows', 'tv');

              // ------------------------------------------
              // B. MENU LOCKDOWN (Keep Only Kids Safe) - (Unchanged)
              // ------------------------------------------

              // Hide dangerous menu links (Trending, Originals, etc)
              document.querySelectorAll('.fs-link').forEach(link => {
                if (
                  link.innerText.includes('Originals') ||
                  link.innerText.includes('Trending') ||
                  link.innerText.includes('Top Rated')
                ) {
                  link.style.display = 'none';
                }
              });

              // Replace Sidebar Genres with Safe Ones
              const gList = document.getElementById("genreList");
              gList.innerHTML = '';

              const safeGenres = [
                { id: 16, name: "Animation" },
                { id: 10751, name: "Family" },
                { id: 12, name: "Adventure" },
                { id: 14, name: "Fantasy" },
                { id: 35, name: "Comedy" },
                { id: 10402, name: "Music" }
              ];

              safeGenres.forEach(g => {
                const el = document.createElement('div');
                el.className = 'genre-tag';
                el.innerText = g.name;
                el.onclick = () => {
                  app.toggleSidebar(false);
                  app.go('network', {
                    id: g.id,
                    name: g.name,
                    type: 'genre'
                  });
                };
                gList.appendChild(el);
              });
            }
            else {
              // ===============================================
              // ADULT MODE: FULL CONTENT LIBRARY
              // ===============================================
              console.log("Loading Adult Content...");

              // 1. Restore Sidebar & Search Links
              document.querySelectorAll('.fs-link').forEach(l => l.style.display = 'block');

              // 2. HERO & SPOTLIGHT (Using Trending)
              const trending = await api.get('/trending/movie/week');
              if (trending && trending.results.length) {
                app.renderHero(trending.results[0]); // #1 Movie
                if (trending.results.length > 1) app.renderSpotlight(trending.results[1]); // #2 Movie
              }

              // 3. GENERATE ROWS (The "Netflix" Experience)

              // Row 1: Global Trends
              ui.row('Trending Now', trending.results, 'homeRows', 'movie');

              // Row 2: TV Shows
              const trendingTv = await api.get('/trending/tv/week');
              if (trendingTv) ui.row('Binge-Worthy TV', trendingTv.results, 'homeRows', 'tv');

              // Row 3: Action & Adventure
              const action = await api.get('/discover/movie', { with_genres: "28,12", sort_by: "popularity.desc" });
              if (action) ui.row('High Octane Action', action.results, 'homeRows', 'movie');

              // Row 4: Sci-Fi & Fantasy
              const scifi = await api.get('/discover/movie', { with_genres: "878,14", sort_by: "popularity.desc" });
              if (scifi) ui.row('Sci-Fi & Cyberpunk', scifi.results, 'homeRows', 'movie');

              // Row 5: Horror (The stuff hidden from kids)
              const horror = await api.get('/discover/movie', { with_genres: "27", sort_by: "popularity.desc" });
              if (horror) ui.row('Late Night Chills', horror.results, 'homeRows', 'movie');

              // Row 6: Comedy
              const comedy = await api.get('/discover/movie', { with_genres: "35", sort_by: "popularity.desc" });
              if (comedy) ui.row('Comedy Hits', comedy.results, 'homeRows', 'movie');

              // Row 7: Top Rated Classics
              const topRated = await api.get('/movie/top_rated', { region: 'US' });
              if (topRated) ui.row('Critics Favorites', topRated.results, 'homeRows', 'movie');

              // Row 8: Documentaries
              const docs = await api.get('/discover/movie', { with_genres: "99", sort_by: "popularity.desc" });
              if (docs) ui.row('Real Stories', docs.results, 'homeRows', 'movie');

              // 4. RESTORE ADULT GENRES IN SIDEBAR
              const allGenres = [
                { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 35, name: 'Comedy' },
                { id: 80, name: 'Crime' }, { id: 18, name: 'Drama' }, { id: 14, name: 'Fantasy' },
                { id: 27, name: 'Horror' }, { id: 878, name: 'Sci-Fi' }, { id: 53, name: 'Thriller' },
                { id: 10749, name: 'Romance' }, { id: 9648, name: 'Mystery' }, { id: 37, name: 'Western' }
              ];

              const gList = document.getElementById("genreList");
              gList.innerHTML = '';
              allGenres.forEach(g => {
                const el = document.createElement('div');
                el.className = 'genre-tag';
                el.innerText = g.name;
                el.onclick = () => {
                  app.toggleSidebar(false);
                  app.go('network', { id: g.id, name: g.name, type: 'genre' });
                };
                gList.appendChild(el);
              });

              // Load "Originals" (Global View Count Leaderboard)
              app.loadOriginals();
            }

            // Load Providers and Originals
            app.renderHomeProviders();
            // Only load global leaderboard if NOT kids (optional, usually originals are mixed ratings)
            if (!isKids) app.loadOriginals();
          },


          // ==========================================
          // LOGOUT CALLBACK
          // ==========================================
          () => {
            console.log("User logged out.");
            app.state.user = null;
            app.state.watchlist = [];
            app.renderWatchlist();

            // Clear Profile Data from LocalStorage
            // This ensures the Gate appears again on next login
            localStorage.removeItem('aether_active_profile');
            localStorage.removeItem('aether_is_kids');
            localStorage.removeItem('aether_theme');

            // Reset UI visibility
            document.querySelector('nav').style.display = 'none';
            document.querySelector('main').style.display = 'none';
            document.getElementById('profileGateView').classList.remove('active');
            document.getElementById('profileGateView').style.display = 'none';

            // Show Auth Screen
            const authView = document.getElementById('view-auth');
            authView.style.display = 'flex';
            gsap.to(authView, { opacity: 1, y: 0, duration: 0.5 });
          }
        );

        // Scroll Event
        window.addEventListener('scroll', () => {
          document.getElementById('navbar').classList.toggle('scrolled', window.scrollY > 50);
        });

        const isKids = localStorage.getItem('aether_is_kids') === 'true';

        if (isKids) {
          // 1. KIDS HOME PAGE
          // Fetch Family & Animation specifically
          const kidsMovies = await api.get('/discover/movie', { with_genres: "16,10751", sort_by: "popularity.desc" });

          if (kidsMovies.results?.length) {
            app.renderHero(kidsMovies.results[0]); // Safe Hero
            if (kidsMovies.results[1]) app.renderSpotlight(kidsMovies.results[1]);
          }

          ui.row('Popular Animation', kidsMovies.results, 'homeRows', 'movie');

          const disney = await api.get('/discover/movie', { with_companies: 2 }); // Disney ID
          ui.row('Disney Favorites', disney.results, 'homeRows', 'movie');

          // 2. Hide Unsafe Elements
          // Hide "Originals" tab link as it's uncontrolled
          document.querySelectorAll('.fs-link').forEach(link => {
            if (link.innerText.includes('Originals')) link.style.display = 'none';
          });

        } else {
          // 1. STANDARD HOME PAGE (Existing code)
          const trending = await api.get('/trending/movie/week');
          if (trending && trending.results?.length) {
            app.renderHero(trending.results[0]);
            if (trending.results.length > 1) app.renderSpotlight(trending.results[1]);
          }
          if (trending) ui.row('Trending Movies', trending.results, 'homeRows', 'movie');

          const action = await api.get('/discover/movie', { with_genres: 28 });
          if (action) ui.row('Adrenaline Rush', action.results, 'homeRows', 'movie');
        }

        app.renderHomeProviders();

        // 3. LOAD GENRES (Conditional)
        const gList = document.getElementById("genreList");
        gList.innerHTML = '';

        let genres = [];
        if (isKids) {
          genres = [
            { id: 16, name: "Animation" },
            { id: 10751, name: "Family" },
            { id: 12, name: "Adventure" },
            { id: 35, name: "Comedy" },
            { id: 14, name: "Fantasy" }
          ];
        } else {
          genres = [
            { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 35, name: 'Comedy' },
            { id: 80, name: 'Crime' }, { id: 18, name: 'Drama' }, { id: 14, name: 'Fantasy' },
            { id: 27, name: 'Horror' }, { id: 878, name: 'Sci-Fi' }, { id: 53, name: 'Thriller' }
          ];
        }

        genres.forEach(g => {
          const el = document.createElement('div'); el.className = 'genre-item'; el.innerText = g.name;
          el.onclick = () => { app.toggleSidebar(false); app.go('network', { id: g.id, name: g.name, type: 'genre' }); };
          gList.appendChild(el);
        });
        // --- FETCH DATA ---
        const trending = await api.get('/trending/movie/week');
        if (trending.results?.length) {
          // Hero gets #1
          app.renderHero(trending.results[0]);

          // Spotlight gets #2 (or a random one from top 5)
          // Using #2 ensures it's different from Hero
          if (trending.results.length > 1) {
            app.renderSpotlight(trending.results[1]);
          }
        }
        //if (trending.results?.length) app.renderHero(trending.results[0]);
        ui.row('Trending Movies', trending.results, 'homeRows', 'movie');

        const trendingTv = await api.get('/trending/tv/week');
        ui.row('Trending TV Shows', trendingTv.results, 'homeRows', 'tv');

        const topTv = await api.get('/tv/top_rated');
        ui.row('Critically Acclaimed Series', topTv.results, 'homeRows', 'tv');

        const action = await api.get('/discover/movie', { with_genres: 28 });
        ui.row('Adrenaline Rush', action.results, 'homeRows', 'movie');

        app.renderHomeProviders();

        // Listeners
        document.getElementById('menuToggle').onclick = app.toggleMenu;
        document.getElementById('sidebarToggle').onclick = app.toggleSidebar;
        document.getElementById('searchInput').addEventListener('input', app.handleSearch);
      },
      // --- AUTH UI HANDLERS ---
      toggleAuthMode: (mode) => {
        const loginBox = document.getElementById('btnContainerLogin');
        const signupBox = document.getElementById('btnContainerSignup');
        const errorMsg = document.getElementById('authError');

        // Clear previous errors
        if (errorMsg) errorMsg.style.display = 'none';

        if (mode === 'signup') {
          // 1. Fade out Login
          gsap.to(loginBox, {
            opacity: 0,
            y: -10,
            duration: 0.3,
            onComplete: () => {
              loginBox.style.display = 'none';

              // 2. Show Signup
              signupBox.style.display = 'block';
              gsap.fromTo(signupBox,
                { opacity: 0, y: 10 },
                { opacity: 1, y: 0, duration: 0.3 }
              );
            }
          });
        } else {
          // 1. Fade out Signup
          gsap.to(signupBox, {
            opacity: 0,
            y: -10,
            duration: 0.3,
            onComplete: () => {
              signupBox.style.display = 'none';

              // 2. Show Login
              loginBox.style.display = 'block';
              gsap.fromTo(loginBox,
                { opacity: 0, y: 10 },
                { opacity: 1, y: 0, duration: 0.3 }
              );
            }
          });
        }
      },

      handleLogin: async () => {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const errorMsg = document.getElementById('authError');

        const res = await loginEmail(email, pass);
        if (!res.success) {
          errorMsg.innerText = res.error;
          errorMsg.style.display = 'block';
          gsap.from(errorMsg, { x: 5, duration: 0.1, repeat: 3, yoyo: true });
        }
      },

      handleRegister: async () => {
        try {
          const email = document.getElementById('authEmail').value;
          const pass = document.getElementById('authPass').value;
          const name = document.getElementById('authName').value;
          const errorMsg = document.getElementById('authError');

          // Validation
          if (!email || !pass || !name) {
            if (errorMsg) {
              errorMsg.innerText = "All fields are required";
              errorMsg.style.display = 'block';
            }
            return;
          }

          if (pass.length < 6) {
            if (errorMsg) {
              errorMsg.innerText = "Password must be at least 6 characters";
              errorMsg.style.display = 'block';
            }
            return;
          }

          const res = await registerEmail(email, pass, name);
          if (!res.success) {
            if (errorMsg) {
              errorMsg.innerText = res.error || "Registration failed";
              errorMsg.style.display = 'block';
            }
          }
          // Success handled by auth observer
        } catch (error) {
          console.error('Registration error:', error);
          const errorMsg = document.getElementById('authError');
          if (errorMsg) {
            errorMsg.innerText = error.message || "An error occurred";
            errorMsg.style.display = 'block';
          }
        }
      },

      handleGoogleLogin: async () => {
        const res = await loginGoogle();
        if (!res.success) alert(res.error);
      },

      signOut: async () => {
        await logoutUser();
        // App state cleared by observer callback
      },

      // 1. CHECK FOR VIOLATION
      checkSafety: (query) => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';
        const isAdultSafety = localStorage.getItem('aether_adult_safety') === 'true';

        if (isKids || isAdultSafety) {
          // .some() stops as soon as it finds ONE match
          const violation = RESTRICTED_TERMS.some(pattern => pattern.test(query));

          if (violation) {
            console.log("Blocked term:", query); // Debugging
            app.triggerSecurityProtocol(); // Trigger the red screen
            return false;
          }
        }
        return true;
      },

      // 2. TRIGGER THE SCARE
      triggerSecurityProtocol: () => {
        const modal = document.getElementById('securityModal');
        const input = document.getElementById('searchInput');

        // Clear input immediately
        if (input) {
          input.value = "";
          input.blur();
        }

        // Close Search Overlay
        app.toggleSearch();

        // Show Scary Modal
        modal.classList.add('active');

        // Optional: Play Error Sound
        // const audio = new Audio('path/to/error.mp3'); audio.play();
      },

      // 3. CLOSE MODAL
      closeSecurityModal: () => {
        document.getElementById('securityModal').classList.remove('active');
      },
      /*
      updateProfileUI: (user) => {
        if (!user) return;

        // Import the profile logic dynamically
        import("./js/firebase/profiles.js").then(async ({ getAccountProfiles, setActiveProfile, getActiveProfileId, createProfile }) => {

          // 1. Fetch Profiles
          const profiles = await getAccountProfiles(user.uid);
          const activeId = getActiveProfileId();

          // 2. Find Active Profile Data
          // If no active profile (first login), default to the first one (Admin)
          let currentPersona = profiles.find(p => p.id === activeId) || profiles[0];

          // 3. Update UI with PERSONA Data (Not just Google Auth Data)
          document.getElementById('settingsName').value = currentPersona.name;
          document.getElementById('userPageName').innerText = currentPersona.name; // Update Profile Page too

          // Update Avatars (Nav + Settings + Profile Page)
          const newAvatar = currentPersona.avatar;
          document.querySelectorAll('.profile-img, .avatar-large img, #userPageAvatar').forEach(img => {
            img.src = newAvatar;
          });

          // 4. Render Switcher List in Settings
          const container = document.getElementById('settingsProfilesList');
          if (container) {
            container.innerHTML = '';

            // A. List Existing Profiles
            profiles.forEach(p => {
              const div = document.createElement('div');
              div.className = `profile-pill-item ${p.id === activeId ? 'active' : ''}`;
              // Add Kids Badge if applicable
              const badge = p.isKids ? '<span style="font-size:9px; background:#fff; color:#000; padding:2px 4px; border-radius:4px; margin-left:5px;">KIDS</span>' : '';

              div.innerHTML = `
                        <img src="${p.avatar}" class="profile-pill-img" style="border: 2px solid ${p.isKids ? '#00ffff' : 'transparent'}">
                        <span class="profile-pill-name">${p.name} ${badge}</span>
                    `;

              div.onclick = () => {
                if (p.id !== activeId) {
                  if (confirm(`Switch to ${p.name}?`)) setActiveProfile(p);
                }
              };
              container.appendChild(div);
            });

            // B. Add "Create Kids Profile" Button (if not maxed out)
            if (profiles.length < 5) {
              const addBtn = document.createElement('div');
              addBtn.className = 'profile-pill-item';
              addBtn.style.borderStyle = 'dashed';
              addBtn.innerHTML = `<i class="fas fa-plus" style="color:#00ffff"></i> <span style="color:#00ffff">Add Kid</span>`;

              addBtn.onclick = async () => {
                const name = prompt("Name for Kids Profile:");
                if (name) {
                  await createProfile(
                    user.uid,
                    name,
                    "https://img.freepik.com/free-vector/cute-astronaut-dance-cartoon-vector-icon-illustration-technology-science-icon-concept-isolated-premium-vector-flat-cartoon-style_138676-3851.jpg", // Kids Avatar
                    "light", // Light theme for kids
                    true // isKids = true
                  );
                  // Refresh UI
                  app.updateProfileUI(user);
                }
              };
              container.appendChild(addBtn);
            }
          }
        });
      },*/


      updateProfileUI: (user) => {
        if (!user) return;

        // Import profile logic
        import("./js/firebase/profiles.js").then(async ({ getAccountProfiles, setActiveProfile, getActiveProfileId }) => {

          // 1. Fetch Profiles
          const profiles = await getAccountProfiles(user.uid);
          const activeId = getActiveProfileId();

          // 2. Find Active Profile Data
          let currentPersona = profiles.find(p => p.id === activeId) || profiles[0];

          // 3. Update Current User UI (Sidebar, Header, etc)
          document.getElementById('settingsName').value = currentPersona.name;
          document.getElementById('userPageName').innerText = currentPersona.name;
          const newAvatar = currentPersona.avatar;
          document.querySelectorAll('.profile-img, .avatar-large img, #userPageAvatar').forEach(img => {
            img.src = newAvatar;
          });

          // 4. Render Switcher List in Settings
          const container = document.getElementById('settingsProfilesList');
          if (container) {
            container.innerHTML = '';

            // A. List Existing Profiles
            profiles.forEach(p => {
              const div = document.createElement('div');
              div.className = `profile-pill-item ${p.id === activeId ? 'active' : ''}`;

              // Add Badge if Kid
              const badge = p.isKids ? '<span style="font-size:9px; background:#00ffff; color:#000; padding:2px 4px; border-radius:4px; margin-left:5px; font-weight:bold;">KIDS</span>' : '';

              div.innerHTML = `
            <img src="${p.avatar}" class="profile-pill-img" style="border: 2px solid ${p.isKids ? '#00ffff' : 'transparent'}">
            <span class="profile-pill-name">${p.name} ${badge}</span>
        `;

              div.onclick = () => {
                if (p.id !== activeId) {
                  // Switch Profile
                  if (confirm(`Switch to ${p.name}?`)) setActiveProfile(p);
                }
              };
              container.appendChild(div);
            });

            // B. Dynamic "Add Profile" Button (Limit 5)
            if (profiles.length < 5) {
              const addBtn = document.createElement('div');
              addBtn.className = 'profile-pill-item';
              addBtn.style.borderStyle = 'dashed';
              addBtn.style.opacity = '0.7';

              // Generic "Add" Icon
              addBtn.innerHTML = `<i class="fas fa-plus" style="color:#fff"></i> <span style="color:#fff">Add</span>`;

              addBtn.onclick = () => {
                // Close Settings Panel
                // (Optional: app.go('home') or close settings)

                // OPEN THE MODAL (Allows choosing Adult or Kid)
                window.profileGateUI.openAddModal();
              };
              container.appendChild(addBtn);
            }


          }
        });
      },

      // --- AVATAR SELECTION LOGIC ---
      /*selectAvatar: async (el) => {
        // 1. UI: Handle Selection Classes
        const grid = document.getElementById('avatarGrid');
        const items = grid.querySelectorAll('.avatar-item');

        items.forEach(item => item.classList.remove('selected'));
        el.classList.add('selected');

        // 2. Get the new Image URL
        const newSrc = el.querySelector('img').src;

        // 3. UI: Update all profile images across the app instantly
        // (Navbar Orb, Settings Header, etc)
        const profileImages = document.querySelectorAll('.profile-img, .avatar-large img');
        profileImages.forEach(img => {
          // Optional: Fade animation
          gsap.to(img, {
            opacity: 0.5, duration: 0.1, onComplete: () => {
              img.src = newSrc;
              gsap.to(img, { opacity: 1, duration: 0.2 });
            }
          });
        });

        // 4. FIREBASE: Save to Cloud (Persistent)
        if (app.state.user) {
          try {
            const auth = getAuth(); // Get auth instance
            await updateProfile(auth.currentUser, {
              photoURL: newSrc
            });
            console.log("Avatar updated in cloud");
          } catch (error) {
            console.error("Error updating avatar:", error);
          }
        } else {
          // Fallback for non-logged-in users (Session only)
          localStorage.setItem('temp_avatar', newSrc);
        }
      },*/

      selectAvatar: async (el) => {
        // UI Update
        document.querySelectorAll(".avatar-item").forEach(i => i.classList.remove("selected"));
        el.classList.add("selected");

        // Get Image URL
        const src = el.querySelector("img").src;

        // Update Visuals Immediately
        document.querySelectorAll(".profile-img, .avatar-large img, #profileAvatar").forEach(img => img.src = src);

        if (app.state.user) {
          // A. Update Firebase Auth (Session)
          try {
            await updateProfile(getAuth().currentUser, { photoURL: src });
          } catch (e) { console.error("Auth Update Error", e); }

          // B. Update Firestore (Database - What friends see)
          // THIS WAS MISSING
          await updateUserProfile(app.state.user.uid, { photoURL: src });

          console.log("Avatar saved to database.");
        } else {
          localStorage.setItem('temp_avatar', src);
        }
      },
      // --- EXISTING FUNCTIONALITY BELOW ---

      initTheme: () => {
        const savedTheme = localStorage.getItem('aether_theme');
        const toggle = document.getElementById('themeToggle');
        if (savedTheme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
          if (toggle) toggle.checked = false;
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          if (toggle) toggle.checked = true;
        }
      },

      // Helper to just apply CSS
      applyTheme: (themeName) => {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('aether_theme', themeName);
        if (themeName === 'light') {
          gsap.to('body', { backgroundColor: '#f3f4f6', duration: 0.5 });
        } else {
          gsap.to('body', { backgroundColor: '#050505', duration: 0.5 });
        }
      },

      toggleTheme: () => {
        const isDark = document.getElementById('themeToggle').checked;
        const newTheme = isDark ? 'dark' : 'light';

        // 1. Apply visual change
        app.applyTheme(newTheme);

        // 2. Save to Cloud
        if (app.state.user) {
          saveUserSettings(app.state.user, { theme: newTheme });
        }
      },
      /*renderHero: (m) => {
        document.getElementById('heroBg').src = IMG_BASE + m.backdrop_path;
        document.getElementById('heroTitle').innerText = m.title || m.name;
        document.getElementById('heroDesc').innerText = m.overview.substring(0, 180) + '...';
        const playBtn = document.getElementById('heroPlayBtn');
        playBtn.onclick = () => app.playVideo(m.id, m.media_type || 'movie', m.title || m.name);
        // Add Stream Button next to Play Trailer
        const heroContent = document.querySelector('.hero-content div[style="display:flex; gap:16px;"]');

        // Create new button
        const streamBtn = document.createElement('button');
        streamBtn.className = 'btn btn-primary magnetic';
        streamBtn.innerHTML = `<i class="fas fa-play"></i> Watch Now`;
        streamBtn.style.background = 'var(--accent)';
        streamBtn.style.color = '#fff';
        streamBtn.style.border = 'none';

        // Insert before "My List"
        heroContent.insertBefore(streamBtn, document.getElementById('heroListBtn'));

        // Handle Click (Need to fetch External IDs for ShowBox support)
        streamBtn.onclick = async () => {
          // Quick fetch of details if needed to ensure we have IMDB ID
          const fullData = await api.get(`/${m.media_type || 'movie'}/${m.id}`, { append_to_response: 'external_ids' });
          player.open(fullData);
        };
        const listBtn = document.getElementById('heroListBtn');
        listBtn.onclick = () => app.toggleWatchlist(m);
        app.updateListBtn(listBtn, m.id);
        gsap.to('#heroBg', { yPercent: 20, ease: 'none', scrollTrigger: { trigger: '.hero', start: 'top top', end: 'bottom top', scrub: true } });
      },*/

      renderHero: (m) => {
        // 1. Basic Info
        document.getElementById('heroBg').src = IMG_BASE + m.backdrop_path;
        document.getElementById('heroTitle').innerText = m.title || m.name;
        document.getElementById('heroDesc').innerText = m.overview.substring(0, 180) + '...';

        // 2. Trailer Button (Hardcoded in HTML)
        const playBtn = document.getElementById('heroPlayBtn');
        playBtn.onclick = () => app.playVideo(m.id, m.media_type || 'movie', m.title || m.name);

        // 3. Dynamic Buttons Container
        const heroContent = document.querySelector('.hero-content div[style="display:flex; gap:16px;"]');
        const listBtn = document.getElementById('heroListBtn');

        // --- A. STREAM BUTTON ---
        const oldStreamBtn = document.getElementById('heroStreamBtn');
        if (oldStreamBtn) oldStreamBtn.remove();

        const streamBtn = document.createElement('button');
        streamBtn.id = 'heroStreamBtn';
        streamBtn.className = 'btn btn-primary magnetic';
        streamBtn.innerHTML = `<i class="fas fa-play"></i> Watch Now`;
        streamBtn.style.background = 'var(--accent)';
        streamBtn.style.color = '#fff';
        streamBtn.style.border = 'none';

        streamBtn.onclick = async () => {
          const fullData = await api.get(`/${m.media_type || 'movie'}/${m.id}`, { append_to_response: 'external_ids' });
          player.open(fullData);
        };

        // --- B. WATCH PARTY BUTTON (NEW) ---
        const oldPartyBtn = document.getElementById('heroPartyBtn');
        if (oldPartyBtn) oldPartyBtn.remove();

        const partyBtn = document.createElement('button');
        partyBtn.id = 'heroPartyBtn';
        partyBtn.className = 'btn btn-blur magnetic';
        partyBtn.innerHTML = `<i class="fas fa-users"></i> Watch Party`;
        partyBtn.style.border = '1px solid var(--accent)';
        partyBtn.style.color = 'var(--accent)';

        partyBtn.onclick = async () => {
          if (window.watchPartyUI) {
            // Pass full object with absolute image path
            const movieData = { ...m, poster_path: POSTER_BASE + m.poster_path };
            await window.watchPartyUI.watchMovie(movieData);
          } else {
            alert("Party system loading...");
          }
        };

        // --- C. INSERTION ---
        // Order: [Trailer] [Stream] [Party] [My List]
        heroContent.insertBefore(streamBtn, listBtn);
        heroContent.insertBefore(partyBtn, listBtn);

        // 4. List Button Logic
        listBtn.onclick = () => app.toggleWatchlist(m);
        app.updateListBtn(listBtn, m.id);

        // 5. Parallax Animation
        gsap.to('#heroBg', { yPercent: 20, ease: 'none', scrollTrigger: { trigger: '.hero', start: 'top top', end: 'bottom top', scrub: true } });
      },


      renderSpotlight: async (m) => {
        if (!m) return;

        // Fetch full details including credits
        const fullData = await api.get(`/movie/${m.id}`, { append_to_response: 'credits,videos' });

        // --- Poster and backdrop URLs ---
        const posterUrl = m.poster_path ? `https://image.tmdb.org/t/p/w500${m.poster_path}` : '';
        const backdropUrl = m.backdrop_path ? `https://image.tmdb.org/t/p/original${m.backdrop_path}` : posterUrl;

        // --- Spotlight background ---
        const section = document.querySelector('.spotlight-section');
        if (section) {
          section.style.backgroundImage = `
      linear-gradient(to bottom, rgba(5,5,5,0.4), rgba(5,5,5,0.9)),
      url('${backdropUrl}')
    `;
          section.style.backgroundSize = 'cover';
          section.style.backgroundPosition = 'center';
          section.style.backgroundRepeat = 'no-repeat';
        }

        // --- Spotlight poster ---
        const posterElem = document.getElementById('spotlightPoster');
        if (posterElem) posterElem.src = posterUrl;

        // --- Spotlight scene / trailer container ---
        const sceneImg = document.getElementById('spotlightBackdrop');
        if (sceneImg) {
          // Use backdrop if available, fallback to poster
          sceneImg.src = backdropUrl;
          sceneImg.alt = m.title || 'Scene';
        }

        // --- Title and description ---
        const titleElem = document.getElementById('spotlightTitle');
        if (titleElem) titleElem.innerHTML = `
    ${m.title}<br>
    <span style="color:var(--accent); font-size:0.6em;">
      ${m.release_date?.split('-')[0] || ''}
    </span>
  `;
        const descElem = document.getElementById('spotlightDesc');
        if (descElem) descElem.innerText = m.overview || '';

        // --- Meta: Rating, Votes, Status, Runtime ---
        document.getElementById('spotlightRating').innerText = m.vote_average?.toFixed(1) || 'N/A';
        document.getElementById('spotlightVotes').innerText = m.vote_count?.toLocaleString() || '0';
        document.getElementById('spotlightStatus').innerText = fullData.status || 'Released';

        const runtime = fullData.runtime || 0;
        const hours = Math.floor(runtime / 60);
        const minutes = runtime % 60;
        document.getElementById('spotlightRuntime').innerText = `${hours}h ${minutes}m`;

        // --- Director ---
        const director = fullData.credits.crew.find(c => c.job === 'Director');
        document.getElementById('spotlightDirector').innerText = director ? director.name : 'Unknown';

        // --- Genres ---
        const genres = fullData.genres.map(g => g.name).slice(0, 3).join(' / ');
        document.getElementById('spotlightGenres').innerText = genres;

        // --- Top 3 Cast ---
        const castContainer = document.getElementById('spotlightCast');
        castContainer.innerHTML = '';
        fullData.credits.cast.slice(0, 3).forEach(actor => {
          if (actor.profile_path) {
            const img = document.createElement('img');
            img.src = `https://image.tmdb.org/t/p/w276_and_h350_face${actor.profile_path}`;
            img.alt = actor.name;
            img.title = actor.name;
            castContainer.appendChild(img);
          }
        });

        // --- Buttons ---
        const watchBtn = document.getElementById('spotlightWatchBtn');
        const sceneBtn = document.getElementById('spotlightSceneBtn'); // trailer container
        const listBtn = document.getElementById('spotlightListBtn');

        const playAction = () => {
          // Play the video/trailer
          let trailer = fullData.videos.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
          if (trailer) {
            app.playVideo(trailer.key, 'movie', m.title); // Pass YouTube key
          } else {
            app.playVideo(m.id, 'movie', m.title); // fallback
          }
        };

        if (watchBtn) watchBtn.onclick = playAction;
        if (sceneBtn) sceneBtn.onclick = playAction;
        if (listBtn) listBtn.onclick = () => app.toggleWatchlist(m);
        app.updateListBtn(listBtn, m.id);
      },


      // SPOTLIGHT STROKES — CINEMATIC INTRO ANIMATION
      initSpotlightStrokes: () => {
        const tl = gsap.timeline({ repeat: -1 });

        // Fade in layers with stagger
        gsap.set(".stroke-layer", { x: "-33%", opacity: 0 });

        // Layer 1: Fastest
        tl.to(".layer-1", {
          x: "33%",
          opacity: 1,
          duration: 14,
          ease: "none"
        }, 0);

        // Layer 2: Medium
        tl.to(".layer-2", {
          x: "33%",
          opacity: 0.8,
          duration: 20,
          ease: "none"
        }, 0);

        // Layer 3: Slowest (parallax)
        tl.to(".layer-3", {
          x: "33%",
          opacity: 0.6,
          duration: 28,
          ease: "none"
        }, 0);

        // Optional: Restart with variation every 30s
        setInterval(() => {
          gsap.to(".stroke-layer", { opacity: 0, duration: 1 });
          setTimeout(() => {
            gsap.set(".stroke-layer", { x: "-33%" });
            app.initSpotlightStrokes();
          }, 1200);
        }, 40000);
      },

      /*renderHomeProviders: async () => {
        // 1. Define the Priority Networks we want to show (IDs from TMDB)
        // 8: Netflix, 337: Disney+, 9: Amazon Prime, 350: Apple TV+, 15: Hulu, 1899: Max, 283: Crunchyroll
        //const priorityIds = [8, 337, 9, 350, 15, 1899, 283];

        const priorityIds = [
          8,     // Netflix
          9,     // Amazon Prime Video
          337,   // Disney+
          350,   // Max (HBO)
          15,    // Hulu
          283,   // Apple TV+
          1899,  // Paramount+

          // Additional Major Global Providers
          531,   // Peacock
          384,   // DAZN
          387,   // Crunchyroll
          386,   // Discovery+
          192,   // YouTube Premium
          40,    // Hotstar
          188,   // Google Play Movies
          24,    // SKY
          1796,  // Lionsgate+
          1853,  // Amazon Freevee
          235,   // Rakuten TV
          207,   // MUBI
          27,    // Viaplay
          185,   // Vudu
          339,   // NOW (UK)
          232,   // Plex
          247,   // Shudder
          443,   // AMC+
          122,   // HBO GO (legacy)
          100,   // iTunes
          2,     // Apple iTunes Store (rent/buy)
          531,   // FuboTV
          309,   // Star+
          118,   // CuriosityStream
          213,   // Netflix Originals (used often in your UI)
        ];

        // 2. Fetch Providers from TMDB
        const res = await api.get('/watch/providers/movie', { watch_region: 'US' });

        if (res.results) {
          const track = document.getElementById('homeProviders');
          track.innerHTML = '';

          // 3. Filter only the major networks and Sort by priority
          const networks = res.results.filter(p => priorityIds.includes(p.provider_id));

          // Sort them based on our priority list order
          networks.sort((a, b) => priorityIds.indexOf(a.provider_id) - priorityIds.indexOf(b.provider_id));

          networks.forEach(p => {
            const d = document.createElement('div');
            d.className = 'provider-pill';

            // 4. Use HIGH RES 'original' image path (Transparent PNGs)
            //const logoUrl = `https://image.tmdb.org/t/p/original${p.logo_path}`;

            const logoUrl = p.logo_path
              ? `https://media.themoviedb.org/t/p/h60${p.logo_path}`
              : 'fallback.png';

            d.innerHTML = `<img src="${logoUrl}" class="provider-logo" alt="${p.name}">`;

            // On Click: Open Network View
            d.onclick = () => app.go('network', {
              id: p.provider_id,
              name: p.provider_name,
              type: 'provider'
            });

            track.appendChild(d);
          });
        }
      },

      toggleProviderGrid: async (shouldOpen) => {
        const ov = document.getElementById('providerOverlay');
        const grid = document.getElementById('providerGrid');
        gsap.killTweensOf(ov);
        if (shouldOpen) {
          ov.style.display = 'block';
          ov.style.opacity = 0;
          await gsap.to(ov, { opacity: 1, duration: 0.35, ease: "power2.out" });
          if (app.state.allProviders.length === 0) {
            grid.innerHTML = `<div style="color:var(--text); text-align:center; grid-column:1/-1; padding:40px;">Fetching global providers...</div>`;
            const res = await api.get('/watch/providers/movie', { watch_region: 'US' });
            if (res.results) {
              app.state.allProviders = res.results.sort((a, b) => a.display_priority - b.display_priority);
              grid.innerHTML = '';
              app.state.visibleProvidersCount = 0;
              app.renderProviderBatch();
            }
          }
        } else {
          await gsap.to(ov, { opacity: 0, duration: 0.25, onComplete: () => ov.style.display = 'none' });
        }
      },

      renderProviderBatch: () => {
        const slice = app.state.allProviders.slice(app.state.visibleProvidersCount, app.state.visibleProvidersCount + 24);
        const grid = document.getElementById('providerGrid');
        const btn = document.getElementById('providerLoadMoreBtn');
        if (slice.length === 0) { btn.style.display = 'none'; return; }
        const newCards = [];
        slice.forEach(p => {
          const el = document.createElement('div'); el.className = 'provider-card-lg';
          el.innerHTML = `<img src="${LOGO_BASE}${p.logo_path}" loading="lazy" alt="${p.provider_name}"><div class="provider-name">${p.provider_name}</div>`;
          el.onclick = () => { app.toggleProviderGrid(false); app.go('network', { id: p.provider_id, name: p.provider_name, type: 'provider' }); };
          grid.appendChild(el);
          newCards.push(el);
        });
        app.state.visibleProvidersCount += slice.length;
        gsap.from(newCards, { y: 30, opacity: 0, scale: 0.95, duration: 0.45, stagger: 0.05, clearProps: "all" });
        btn.style.display = (app.state.visibleProvidersCount >= app.state.allProviders.length) ? 'none' : 'block';
      },*/


      renderHomeProviders: async () => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';

        // 1. Define Priority Lists
        let priorityIds = [];
        let sectionTitle = "Partners";

        if (isKids) {
          // --- KIDS CURATION ---
          priorityIds = [
            337,   // Disney+ (قناة الأطفال)
            1899,  // Paramount+ (نيكلوديون)
            8,     // Netflix (فلترة ستعمل في الواجهة التالية)
            531,   // Peacock (دريم ووركس)
            350,   // Apple TV+ (سنوبي)
            567,   // PBS Kids (تعليمي)
            432,   // Noggin/Nick Jr.
            289,   // Boomerang (كرتون كلاسيكي)
            654    // Kidoodle.TV (آمن للأطفال)
          ];
          sectionTitle = "Kids Channels";

        } else {
          // --- ADULT / STANDARD CURATION ---
          priorityIds = [
            8,     // Netflix
            9,     // Amazon Prime Video
            337,   // Disney+
            350,   // Apple TV+
            1899,  // Paramount+
            15,    // Hulu
            531,   // Peacock
            384,   // DAZN
            247,   // Shudder
            443,   // AMC+
            27,    // Viaplay
            387,   // Max
            283,   // Crunchyroll
            192,   // YouTube
            2      // Apple iTunes
          ];
        }

        // 2. Fetch Global Providers
        const res = await api.get('/watch/providers/movie', { watch_region: 'US' });

        if (res.results) {
          const track = document.getElementById('homeProviders');
          track.innerHTML = '';

          // Update section title
          const label = document.querySelector('.providers-wrap span');
          if (label) label.innerText = sectionTitle;

          // 3. Filter & Sort based on the list defined above
          const networks = res.results
            .filter(p => priorityIds.includes(p.provider_id))
            .sort((a, b) => priorityIds.indexOf(a.provider_id) - priorityIds.indexOf(b.provider_id));

          networks.forEach(p => {
            const d = document.createElement('div');
            d.className = 'provider-pill';

            const logoUrl = p.logo_path
              ? `https://media.themoviedb.org/t/p/h60${p.logo_path}`
              : 'fallback.png';

            d.innerHTML = `<img src="${logoUrl}" class="provider-logo" alt="${p.name}">`;

            // عند النقر: نفتح واجهة الشبكة مع فلترة محتوى الأطفال
            d.onclick = () => {
              if (isKids) {
                // إنشاء فلتر محتوى آمن للأطفال
                const kidsFilter = {
                  certification_country: 'US',
                  certification: KIDS_AGE_RATINGS.join('|'),
                  with_genres: KIDS_CONTENT_TYPES.join(','),
                  include_adult: false,
                  include_video: false
                };

                app.go('network', {
                  id: p.provider_id,
                  name: p.provider_name,
                  type: 'provider',
                  filter: kidsFilter,
                  isKids: true
                });
              } else {
                app.go('network', {
                  id: p.provider_id,
                  name: p.provider_name,
                  type: 'provider'
                });
              }
            };

            track.appendChild(d);
          });
        }
      },

      toggleProviderGrid: async (shouldOpen) => {
        const ov = document.getElementById('providerOverlay');
        const grid = document.getElementById('providerGrid');
        const isKids = localStorage.getItem('aether_is_kids') === 'true';

        gsap.killTweensOf(ov);

        if (shouldOpen) {
          ov.style.display = 'block';
          ov.style.opacity = 0;
          await gsap.to(ov, { opacity: 1, duration: 0.35, ease: "power2.out" });

          // تحديث عنوان الشبكة
          const gridTitle = document.querySelector('#providerOverlay .grid-title');
          if (gridTitle) {
            gridTitle.innerText = isKids ? "Kids Channels" : "All Channels";
          }

          // نعيد تحميل المحتوى دائماً للتأكد من المزامنة
          grid.innerHTML = `<div style="color:var(--text); text-align:center; grid-column:1/-1; padding:40px;">
      ${isKids ? "Loading safe kids channels..." : "Loading all channels..."}
    </div>`;

          const res = await api.get('/watch/providers/movie', { watch_region: 'US' });
          if (res.results) {
            // فلترة المنصات حسب وضع الأطفال
            let providers = res.results;

            if (isKids) {
              // فلترة مزدوجة: 1. منصات موصى بها 2. مع فلترة محتوى
              const recommendedKidsProviders = [
                337, 1899, 8, 531, 350, 567, 432, 289, 654, 721
              ];
              providers = providers.filter(p =>
                recommendedKidsProviders.includes(p.provider_id)
              );
            }

            app.state.allProviders = providers.sort((a, b) => a.display_priority - b.display_priority);
            grid.innerHTML = '';
            app.state.visibleProvidersCount = 0;
            app.renderProviderBatch();
          }
        } else {
          await gsap.to(ov, {
            opacity: 0,
            duration: 0.25,
            onComplete: () => ov.style.display = 'none'
          });
        }
      },

      renderProviderBatch: () => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';

        const slice = app.state.allProviders.slice(
          app.state.visibleProvidersCount,
          app.state.visibleProvidersCount + 24
        );

        const grid = document.getElementById('providerGrid');
        const btn = document.getElementById('providerLoadMoreBtn');

        if (slice.length === 0) {
          if (app.state.visibleProvidersCount === 0) {
            grid.innerHTML = `<div style="color:var(--text); text-align:center; grid-column:1/-1; padding:40px;">
        ${isKids ? "No kids channels available" : "No channels available"}
      </div>`;
          }
          btn.style.display = 'none';
          return;
        }

        const newCards = [];
        slice.forEach(p => {
          const el = document.createElement('div');
          el.className = 'provider-card-lg';
          el.innerHTML = `
      <img src="${LOGO_BASE}${p.logo_path}" loading="lazy" alt="${p.provider_name}">
      <div class="provider-name">${p.provider_name}</div>
    `;

          el.onclick = () => {
            app.toggleProviderGrid(false);

            if (isKids) {
              // فلترة محتوى الأطفال عند النقر
              const kidsFilter = {
                certification_country: 'US',
                certification: KIDS_AGE_RATINGS.join('|'),
                with_genres: KIDS_CONTENT_TYPES.join(','),
                include_adult: false,
                include_video: false,
                'vote_average.gte': 0,
                'vote_average.lte': 10
              };

              app.go('network', {
                id: p.provider_id,
                name: p.provider_name,
                type: 'provider',
                filter: kidsFilter,
                isKids: true
              });
            } else {
              app.go('network', {
                id: p.provider_id,
                name: p.provider_name,
                type: 'provider'
              });
            }
          };

          grid.appendChild(el);
          newCards.push(el);
        });

        app.state.visibleProvidersCount += slice.length;
        gsap.from(newCards, {
          y: 30,
          opacity: 0,
          scale: 0.95,
          duration: 0.45,
          stagger: 0.05,
          clearProps: "all"
        });

        btn.style.display = (app.state.visibleProvidersCount >= app.state.allProviders.length) ? 'none' : 'block';
      },

      // دالة مساعدة لفحص محتوى الأطفال
      checkIfContentIsKidFriendly: (content) => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';

        if (!isKids) return true; // إذا لم يكن وضع الأطفال مفعلاً

        // فحص التصنيف العمري
        const ageRating = content.certification || content.rating || '';
        if (ageRating && KIDS_AGE_RATINGS.includes(ageRating)) {
          return true;
        }

        // فحص الأنواع
        const genres = content.genres || [];
        const hasKidFriendlyGenre = genres.some(genre =>
          KIDS_CONTENT_TYPES.includes(genre.name)
        );

        return hasKidFriendlyGenre;
      },


      go: async (view, params = null) => {
        app.toggleSidebar(false);
        if (app.state.menuOpen) app.toggleMenu();
        if (app.state.searchOpen) app.toggleSearch();
        app.toggleProviderGrid(false);
        const current = document.querySelector('.view-container.active');
        if (current) {
          gsap.to(current, { opacity: 0, duration: 0.3, onComplete: () => { current.classList.remove('active'); current.style.display = 'none'; } });
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const target = document.getElementById(`view-${view}`);
        if (view === 'detail') await app.loadDetail(params);
        if (view === 'network') await app.initNetworkView(params);
        if (view === 'watchlist') app.renderWatchlist();
        if (view === 'constellation') {
          // No specific load function needed here, handled by openConstellation
        }
        // NEW VIEWS
        if (view === 'originals') await app.loadOriginals();
        if (view === 'profile') await app.loadProfile();
        const closeBtn = document.getElementById('closeViewBtn');
        if (view === 'home') closeBtn.classList.remove('active');
        else closeBtn.classList.add('active');
        setTimeout(() => { target.style.display = 'block'; target.classList.add('active'); anim.pageTrans(`view-${view}`); }, 300);
      },


      /*loadDetail: async (params) => {
        const { id, type } = params;
        const m = await api.get(`/${type}/${id}`, { append_to_response: "external_ids,credits,recommendations" });
        app.state.currentMedia = m;

        //(Basic Info Population: Title, Desc, Backdrop - KEEP EXISTING) ...
        document.getElementById("dtBackdrop").src = IMG_BASE + m.backdrop_path;
        document.getElementById("dtPoster").src = POSTER_BASE + m.poster_path;
        document.getElementById("dtTitle").innerText = m.title || m.name;
        document.getElementById("dtDesc").innerText = m.overview;
        document.getElementById("dtYear").innerText = (m.release_date || m.first_air_date || '').split('-')[0];
        document.getElementById("dtRuntime").innerText = type === 'movie' ? (m.runtime + 'm') : (m.number_of_seasons + ' Seasons');

        // --- 1. CHECK USER STATE (Favorite & Rating) ---
        const user = app.state.user;
        const favBtn = document.getElementById("dtFavBtn");
        const stars = document.querySelectorAll('#dtUserRating .star-btn');

        // Reset UI
        favBtn.classList.remove('active');
        stars.forEach(s => s.classList.remove('filled'));

        if (user) {
          // Check Favorites (We need to fetch user profile to know)
          const userData = await getUserData(user);
          const isFav = (userData.favorites || []).some(f => f.id === m.id);
          if (isFav) favBtn.classList.add('active');

          // Check Rating
          const myRating = await getUserRating(user, m.id);
          if (myRating > 0) {
            stars.forEach((s, idx) => {
              if (idx < myRating) s.classList.add('filled');
            });
          }
        }

        // --- 2. BIND EVENTS ---

        // Favorite Click
        favBtn.onclick = () => app.toggleFavorite(m, favBtn);

        // Star Click
        stars.forEach(star => {
          star.onclick = () => {
            const val = parseInt(star.getAttribute('data-val'));
            app.setUserRating(m, val);
          };
        });

        // ... (Buttons: Play, List, Stream - KEEP EXISTING LOGIC) ...
        document.getElementById("dtPlayBtn").onclick = () => app.playVideo(m.id, type, m.title || m.name);

        const container = document.querySelector('#view-detail .detail-info div[style="display:flex; align-items:center; gap:16px; margin-bottom:50px;"]');

        // Stream Button Logic (Ensure no duplicates)
        const oldBtn = document.getElementById("dtStreamBtn");
        if (oldBtn) oldBtn.remove();
        const sBtn = document.createElement("button");
        sBtn.id = "dtStreamBtn";
        sBtn.className = "btn btn-primary magnetic";
        sBtn.innerHTML = `<i class="fas fa-play"></i> Start Stream`;
        sBtn.style.background = "var(--accent)";
        sBtn.style.border = "none";
        sBtn.onclick = () => player.open(m);

        // Insert correctly in the row
        container.insertBefore(sBtn, document.getElementById("dtListBtn"));

        const lBtn = document.getElementById("dtListBtn");
        lBtn.onclick = () => app.toggleWatchlist(m);
        app.updateListBtn(lBtn, m.id);

        // ... (Seasons, Cast, Recs - KEEP EXISTING LOGIC) ...
        // (Paste the rest of your existing loadDetail code here for Seasons/Cast)
        const seasonCon = document.getElementById("seasonContainer");
        const seasonList = document.getElementById("dtSeasons");
        const epList = document.getElementById("dtEpisodes");
        seasonList.innerHTML = ''; epList.innerHTML = '';

        if (type === 'tv' && m.seasons) {
          seasonCon.style.display = 'block';
          m.seasons.forEach(s => {
            if (s.season_number > 0 && s.poster_path) {
              const d = document.createElement("div");
              d.className = "season-card";
              d.innerHTML = `<img class="season-img" src="${POSTER_BASE}${s.poster_path}"><div class="season-info">Season ${s.season_number}</div>`;
              d.onclick = async () => {
                document.querySelectorAll(".season-card").forEach(c => c.classList.remove('active'));
                d.classList.add('active');
                const epData = await api.get(`/tv/${id}/season/${s.season_number}`);
                app.renderEpisodes({ episodes: epData.episodes, seasonNumber: s.season_number, showName: m.name, showId: id });
              };
              seasonList.appendChild(d);
            }
          });
        } else seasonCon.style.display = 'none';

        const castEl = document.getElementById("dtCast");
        castEl.innerHTML = '';

        if (m.credits?.cast) {
          m.credits.cast.slice(0, 10).forEach(p => {
            if (p.profile_path) {
              const item = document.createElement('div');
              item.className = 'cast-item';
              // Use actorUI.openActorProfile on click
              item.innerHTML = `
         <img class="cast-img" src="${POSTER_BASE}${p.profile_path}" 
              style="cursor:pointer" 
              onclick="actorUI.openActorProfile(${p.id})">
         <div>${p.name}</div>
       `;
              castEl.appendChild(item);
            }
          });
        }

        const recEl = document.getElementById("recContainer");
        recEl.innerHTML = '';
        ui.row("More Like This", m.recommendations?.results, "recContainer", type);
      },*/

      loadDetail: async (params) => {
        const { id, type } = params;

        // 1. Fetch Data
        const m = await api.get(`/${type}/${id}`, {
          append_to_response: "external_ids,credits,recommendations,release_dates,content_ratings"
        });
        if (localStorage.getItem('aether_is_kids') === 'true') {
          let isSafe = true;

          // CHECK 1: Genres
          const badGenres = ["Horror", "Crime", "Thriller", "War"];
          if (m.genres.some(g => badGenres.includes(g.name))) isSafe = false;

          // CHECK 2: Ratings (Certification)
          let rating = '';
          if (type === 'movie' && m.release_dates) {
            const usRelease = m.release_dates.results.find(r => r.iso_3166_1 === 'US');
            if (usRelease) {
              // Get the first release certification
              rating = usRelease.release_dates[0].certification;
            }
          } else if (type === 'tv' && m.content_ratings) {
            const usRating = m.content_ratings.results.find(r => r.iso_3166_1 === 'US');
            if (usRating) rating = usRating.rating;
          }

          const badRatings = ['R', 'NC-17', 'TV-MA', 'TV-14']; // TV-14 is borderline, decide if you want it
          if (badRatings.includes(rating)) isSafe = false;

          if (!isSafe) {
            alert("This content is restricted in Kids Profile.");
            app.go('home'); // EJECT TO HOME
            return;
          }
        }
        // ==========================================

        app.state.currentMedia = m;

        // 2. Populate Info
        document.getElementById("dtBackdrop").src = IMG_BASE + m.backdrop_path;
        document.getElementById("dtPoster").src = POSTER_BASE + m.poster_path;
        document.getElementById("dtTitle").innerText = m.title || m.name;
        document.getElementById("dtDesc").innerText = m.overview;
        document.getElementById("dtYear").innerText = (m.release_date || m.first_air_date || '').split('-')[0];
        document.getElementById("dtRuntime").innerText = type === 'movie' ? (m.runtime + 'm') : (m.number_of_seasons + ' Seasons');

        // 3. User State Logic (Async)
        const user = app.state.user;
        let isFav = false;
        let myRating = 0;

        // Reset Stars UI
        document.querySelectorAll('#dtUserRating .star-btn').forEach(s => s.classList.remove('filled'));

        if (user) {
          import("./js/firebase/db.js").then(async ({ getUserData, getUserRating }) => {
            const userData = await getUserData(user);
            isFav = (userData.favorites || []).some(f => f.id === m.id);

            myRating = await getUserRating(user, m.id);
            if (myRating > 0) {
              document.querySelectorAll('#dtUserRating .star-btn').forEach((s, i) => {
                if (i < myRating) s.classList.add('filled');
              });
            }

            // Refresh button state after fetching data
            updateButtonStates();
          });
        }

        // --- 4. BUILD ACTION BAR (THE FIX) ---
        // Find the container where buttons usually go (or create one if missing)
        let actionContainer = document.querySelector('.detail-actions-bar');

        // If we are replacing the old HTML structure, find the old container and replace it
        if (!actionContainer) {
          const oldContainer = document.querySelector('#view-detail .detail-info div[style*="display:flex"]');
          if (oldContainer) {
            // Create new container
            actionContainer = document.createElement('div');
            actionContainer.className = 'detail-actions-bar';
            oldContainer.parentNode.insertBefore(actionContainer, oldContainer);
            oldContainer.remove(); // Remove old messy container
          }
        }

        // Clear container to rebuild
        actionContainer.innerHTML = '';

        // SECTION A: PRIMARY (Watch)
        const primaryRow = document.createElement('div');
        primaryRow.className = 'actions-primary';

        const streamBtn = document.createElement('button');
        streamBtn.className = 'btn btn-primary magnetic';
        streamBtn.innerHTML = `<i class="fas fa-play"></i> Watch Now`;
        streamBtn.onclick = () => player.open(m);

        const partyBtn = document.createElement('button');
        partyBtn.className = 'btn btn-blur magnetic';
        partyBtn.innerHTML = `<i class="fas fa-users"></i> Watch Party`;
        partyBtn.style.border = '1px solid var(--accent)';
        partyBtn.style.color = 'var(--accent)';
        partyBtn.onclick = async () => {
          const data = { ...m, poster_path: POSTER_BASE + m.poster_path };
          watchPartyUI.watchMovie(data);
        };

        primaryRow.appendChild(streamBtn);
        primaryRow.appendChild(partyBtn);

        // SECTION B: SECONDARY (Tools)
        const secondaryRow = document.createElement('div');
        secondaryRow.className = 'actions-secondary';

        // 1. Trailer
        const trailerBtn = document.createElement('button');
        trailerBtn.className = 'btn-tool';
        trailerBtn.innerHTML = `<i class="fas fa-film"></i> Trailer`;
        trailerBtn.onclick = () => app.playVideo(m.id, type, m.title || m.name);

        // 2. Watchlist
        const listBtn = document.createElement('button');
        listBtn.id = 'dtListBtn'; // ID for updates
        listBtn.className = 'btn-tool';
        listBtn.innerHTML = `<i class="fas fa-plus"></i> List`;
        listBtn.onclick = () => app.toggleWatchlist(m);

        // 3. Favorite (Icon)
        const favBtn = document.createElement('button');
        favBtn.id = 'dtFavBtn';
        favBtn.className = 'btn-tool-icon';
        favBtn.title = "Favorite";
        favBtn.innerHTML = `<i class="fas fa-heart"></i>`;
        favBtn.onclick = () => app.toggleFavorite(m, favBtn);

        // 4. Aether Lens (Icon)
        const lensBtn = document.createElement('button');
        lensBtn.className = 'btn-tool-icon';
        lensBtn.title = "AI Analysis";
        lensBtn.innerHTML = `<i class="fas fa-eye"></i>`;
        lensBtn.onclick = () => window.lensUI.toggle(m);

        secondaryRow.appendChild(trailerBtn);
        secondaryRow.appendChild(listBtn);
        secondaryRow.appendChild(favBtn);
        secondaryRow.appendChild(lensBtn);

        // Append to Main Container
        actionContainer.appendChild(primaryRow);
        actionContainer.appendChild(secondaryRow);

        // Helper to update button visuals after async data loads
        const updateButtonStates = () => {
          if (isFav) favBtn.classList.add('active');
          app.updateListBtn(listBtn, m.id);
        };

        // Run initial update for List status (local storage check)
        app.updateListBtn(listBtn, m.id);


        // --- 5. REST OF PAGE (Seasons, Cast, Recs) ---
        const seasonCon = document.getElementById("seasonContainer");
        const seasonList = document.getElementById("dtSeasons");
        seasonList.innerHTML = ''; document.getElementById('dtEpisodes').innerHTML = '';

        if (type === 'tv' && m.seasons) {
          seasonCon.style.display = 'block';
          m.seasons.forEach(s => {
            if (s.season_number > 0 && s.poster_path) {
              const d = document.createElement("div");
              d.className = "season-card";
              d.innerHTML = `<img class="season-img" src="${POSTER_BASE}${s.poster_path}"><div class="season-info">Season ${s.season_number}</div>`;
              d.onclick = async () => {
                document.querySelectorAll(".season-card").forEach(c => c.classList.remove('active'));
                d.classList.add('active');
                const epData = await api.get(`/tv/${id}/season/${s.season_number}`);
                app.renderEpisodes({ episodes: epData.episodes, seasonNumber: s.season_number, showName: m.name, showId: id });
              };
              seasonList.appendChild(d);
            }
          });
        } else seasonCon.style.display = 'none';

        // Cast
        const castEl = document.getElementById("dtCast");
        castEl.innerHTML = '';
        if (m.credits?.cast) {
          m.credits.cast.slice(0, 10).forEach(p => {
            if (p.profile_path) {
              const item = document.createElement('div');
              item.className = 'cast-item';
              item.innerHTML = `
                    <img class="cast-img" src="${POSTER_BASE}${p.profile_path}" style="cursor:pointer" onclick="actorUI.openActorProfile(${p.id})">
                    <div>${p.name}</div>
                `;
              castEl.appendChild(item);
            }
          });
        }

        // Recommendations
        // Recommendations
        const recEl = document.getElementById("recContainer");
        recEl.innerHTML = '';

        if (m.recommendations && m.recommendations.results) {

          // 1. FILTER unsafe content
          const safeRecs = app.filterSafeContent(m.recommendations.results);

          // 2. DISPLAY safe list OR fallback
          if (safeRecs.length > 0) {
            ui.row("More Like This", safeRecs, "recContainer", type);
          } else {
            recEl.innerHTML = `
              <div style="
                color: gray; 
                padding: 20px; 
                font-size: 14px; 
                text-align: center;
               ">
                 No safe recommendations available.
              </div>`;
          }

        } else {
          recEl.innerHTML = `
            <div style="
              color: gray; 
              padding: 20px; 
              font-size: 14px; 
              text-align: center;
            ">
            No recommendations available.
          </div>`;
        }


        // Setup Star Rating Clicks
        const stars = document.querySelectorAll('#dtUserRating .star-btn');
        stars.forEach(star => {
          star.onclick = () => app.setUserRating(m, parseInt(star.getAttribute('data-val')));
        });
      },

      updateSidebarGenres: () => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';
        const gList = document.getElementById("genreList");
        gList.innerHTML = ''; // Clear existing

        let validGenres = [];

        if (isKids) {
          // --- KIDS GENRES ---
          validGenres = [
            { id: 16, name: "Animation" },
            { id: 10751, name: "Family" },
            { id: 12, name: "Adventure" },
            { id: 14, name: "Fantasy" },
            { id: 35, name: "Comedy" },
            { id: 10402, name: "Music" },
            { id: 878, name: "Sci-Fi" } // Usually safe if paired with PG filter
          ];
        } else {
          // --- ADULT GENRES ---
          validGenres = [
            { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 35, name: 'Comedy' },
            { id: 80, name: 'Crime' }, { id: 18, name: 'Drama' }, { id: 14, name: 'Fantasy' },
            { id: 27, name: 'Horror' }, { id: 878, name: 'Sci-Fi' }, { id: 53, name: 'Thriller' },
            { id: 10749, name: 'Romance' }, { id: 9648, name: 'Mystery' }, { id: 37, name: 'Western' }
          ];
        }

        // Render Logic
        validGenres.forEach(g => {
          const el = document.createElement("div");
          el.className = "genre-tag";
          el.innerText = g.name;
          el.onclick = () => {
            app.toggleSidebar(false);

            // NOTE: api.get() global filter handles the safety. 
            // Even if they click "Sci-Fi", the API will receive "&certification_lte=PG"
            app.go("network", { id: g.id, name: g.name, type: "genre" });
          };
          gList.appendChild(el);
        });
      },

      /*
        loadDetail: async (params) => {
          const { id, type } = params;
          console.log("Loading Detail for:", id, type);
  
          // 1. Fetch Data
          const m = await api.get(`/${type}/${id}`, { append_to_response: "external_ids,credits,recommendations" });
          app.state.currentMedia = m;
  
          // 2. Populate Info
          document.getElementById("dtBackdrop").src = IMG_BASE + m.backdrop_path;
          document.getElementById("dtPoster").src = POSTER_BASE + m.poster_path;
          document.getElementById("dtTitle").innerText = m.title || m.name;
          document.getElementById("dtDesc").innerText = m.overview;
          document.getElementById("dtYear").innerText = (m.release_date || m.first_air_date || '').split('-')[0];
          document.getElementById("dtRuntime").innerText = type === 'movie' ? (m.runtime + 'm') : (m.number_of_seasons + ' Seasons');
  
          // 3. User State (Favorites/Rating)
          const user = app.state.user;
          const favBtn = document.getElementById("dtFavBtn");
          const stars = document.querySelectorAll('#dtUserRating .star-btn');
  
          favBtn.classList.remove('active');
          stars.forEach(s => s.classList.remove('filled'));
  
          if (user) {
            import("./js/firebase/db.js").then(async ({ getUserData, getUserRating }) => {
              const userData = await getUserData(user);
              const isFav = (userData.favorites || []).some(f => f.id === m.id);
              if (isFav) favBtn.classList.add('active');
  
              const myRating = await getUserRating(user, m.id);
              if (myRating > 0) stars.forEach((s, i) => i < myRating && s.classList.add('filled'));
            });
          }
  
          // 4. Bind Standard Buttons
          favBtn.onclick = () => app.toggleFavorite(m, favBtn);
          stars.forEach(star => {
            star.onclick = () => app.setUserRating(m, parseInt(star.getAttribute('data-val')));
          });
          document.getElementById("dtPlayBtn").onclick = () => app.playVideo(m.id, type, m.title || m.name);
          const listBtn = document.getElementById("dtListBtn");
          listBtn.onclick = () => app.toggleWatchlist(m);
          app.updateListBtn(listBtn, m.id);
  
  
          // --- 5. DYNAMIC BUTTONS (Stream & Party) ---
  
          // FIX: Safer way to find the button container
          const container = listBtn.parentNode;
  
          // A. Remove old buttons to prevent duplicates
          const oldStream = document.getElementById("dtStreamBtn");
          const oldParty = document.getElementById("dtPartyBtn");
          if (oldStream) oldStream.remove();
          if (oldParty) oldParty.remove();
  
          // B. Create Watch Party Button
          const partyBtn = document.createElement("button");
          partyBtn.id = "dtPartyBtn";
          partyBtn.className = "btn btn-blur magnetic";
          partyBtn.innerHTML = `<i class="fas fa-users"></i> Watch Party`;
          partyBtn.style.cssText = "border: 1px solid var(--accent); color: var(--accent); margin-right: 10px;";
  
          partyBtn.onclick = async () => {
            console.log("Watch Party Button Clicked"); // DEBUG LOG
  
            if (window.watchPartyUI) {
              const movieForSession = {
                ...m,
                poster_path: POSTER_BASE + m.poster_path
              };
              await window.watchPartyUI.watchMovie(movieForSession);
            } else {
              alert("Party system is not loaded yet.");
            }
          };
  
          // Create LENS Button
          const lensBtn = document.createElement("button");
          lensBtn.className = "btn-icon magnetic";
          lensBtn.innerHTML = `<i class="fas fa-eye"></i>`;
          lensBtn.title = "Activate Aether Lens";
          lensBtn.style.marginLeft = "10px";
          lensBtn.style.border = "1px solid var(--text-muted)";
  
          lensBtn.onclick = () => {
            window.lensUI.toggle(m); // Pass the current movie object
          };
  
          // Add to the container (at the end)
          // container is the div holding Play/Stream/Party buttons
          container.appendChild(lensBtn);
  
          // C. Create Stream Button
          const streamBtn = document.createElement("button");
          streamBtn.id = "dtStreamBtn";
          streamBtn.className = "btn btn-primary magnetic";
          streamBtn.innerHTML = `<i class="fas fa-play"></i> Start Stream`;
          streamBtn.style.cssText = "background: var(--accent); border: none; color: #fff; margin-right: 10px;";
  
          streamBtn.onclick = () => {
            if (window.player) window.player.open(m);
          };
  
          // D. Insert Buttons (Order: Play Trailer -> Stream -> Party -> List -> Fav)
          container.insertBefore(partyBtn, listBtn);
          container.insertBefore(streamBtn, partyBtn);
  
  
          // --- 6. Seasons & Cast ---
          const seasonCon = document.getElementById("seasonContainer");
          const seasonList = document.getElementById("dtSeasons");
          const epList = document.getElementById("dtEpisodes");
          seasonList.innerHTML = ''; epList.innerHTML = '';
  
          if (type === 'tv' && m.seasons) {
            seasonCon.style.display = 'block';
            m.seasons.forEach(s => {
              if (s.season_number > 0 && s.poster_path) {
                const d = document.createElement("div");
                d.className = "season-card";
                d.innerHTML = `<img class="season-img" src="${POSTER_BASE}${s.poster_path}"><div class="season-info">Season ${s.season_number}</div>`;
                d.onclick = async () => {
                  document.querySelectorAll(".season-card").forEach(c => c.classList.remove('active'));
                  d.classList.add('active');
                  const epData = await api.get(`/tv/${id}/season/${s.season_number}`);
                  app.renderEpisodes({ episodes: epData.episodes, seasonNumber: s.season_number, showName: m.name, showId: id });
                };
                seasonList.appendChild(d);
              }
            });
          } else seasonCon.style.display = 'none';
  
          const castEl = document.getElementById("dtCast");
          castEl.innerHTML = '';
          if (m.credits?.cast) {
            m.credits.cast.slice(0, 10).forEach(p => {
              if (p.profile_path) {
                const item = document.createElement('div');
                item.className = 'cast-item';
                item.innerHTML = `<img class="cast-img" src="${POSTER_BASE}${p.profile_path}" style="cursor:pointer" onclick="actorUI.openActorProfile(${p.id})"><div>${p.name}</div>`;
                castEl.appendChild(item);
              }
            });
          }
  
          const recEl = document.getElementById("recContainer");
          recEl.innerHTML = '';
          ui.row("More Like This", m.recommendations?.results, "recContainer", type);
        },
  
  */
      // --- FAVORITES LOGIC ---
      toggleFavorite: async (m, btn) => {
        const user = app.state.user;
        if (!user) return alert("Please login to save favorites.");

        // Check local state (we need to store favorites locally or check class)
        const isActive = btn.classList.contains('active');

        if (isActive) {
          btn.classList.remove('active');
          await removeFavorite(user, m);
        } else {
          btn.classList.add('active');
          // Animation
          gsap.fromTo(btn, { scale: 1.5 }, { scale: 1, duration: 0.4, ease: "elastic.out(1, 0.3)" });
          await addFavorite(user, m);
        }
      },

      // --- RATING LOGIC ---
      setUserRating: async (m, rating) => {
        const user = app.state.user;
        if (!user) return alert("Please login to rate.");

        // Visual Update
        const stars = document.querySelectorAll('#dtUserRating .star-btn');
        stars.forEach((s, idx) => {
          if (idx < rating) s.classList.add('filled');
          else s.classList.remove('filled');
        });

        // DB Update
        await rateMediaUser(user, m, rating);
      },

      // --- ORIGINALS (Global Ranking) ---


      loadOriginals: async () => {
        const grid = document.getElementById('originalsGrid');
        if (!grid) return;

        grid.innerHTML = '<div style="grid-column:1/-1; color:var(--text-muted); padding:40px; text-align:center;">Fetching global leaderboard...</div>';

        try {
          const rankings = await getGlobalRankings(20);

          grid.innerHTML = '';

          if (!rankings || rankings.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; color:var(--text-muted); padding:40px; text-align:center;">No data yet.</div>';
            return;
          }

          for (let i = 0; i < rankings.length; i++) {
            let item = rankings[i];
            const type = item.media_type || 'movie';

            // 1. Hydrate if missing BACKDROP (Horizontal Image)
            /*if (!item.backdrop_path) {
              try {
                const res = await api.get(`/${type}/${item.id}`);
                if (res) item = { ...item, ...res };
              } catch (e) {
                continue;
              }
            }*/

            if (!item.backdrop_path) {
              try {
                // Try fetching as the saved type
                let res = await api.get(`/${type}/${item.id}`);
                
                // If failed (res is null/undefined) and type was movie, TRY TV
                if ((!res || !res.poster_path) && type === 'movie') {
                     const tvRes = await api.get(`/tv/${item.id}`);
                     if (tvRes && tvRes.id) {
                         res = tvRes;
                         type = 'tv'; // Correct the type for the click handler
                     }
                }

                if (res) item = { ...item, ...res };
              } catch (e) {
                console.log("Hydration failed for", item.title);
                continue;
              }
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'ranked-wrapper';

            // 2. Use BACKDROP_PATH for Horizontal Card
            // Fallback to poster_path if backdrop is missing
            const imgPath = item.backdrop_path || item.poster_path;

            const imgUrl = imgPath
              ? `https://image.tmdb.org/t/p/w500${imgPath}`
              : 'https://via.placeholder.com/500x280?text=No+Image';

            wrapper.innerHTML = `
              <div class="rank-badge">${i + 1}</div>
              <div class="ranked-card">
                <img src="${imgUrl}" loading="lazy" alt="${item.title}">
          
                <!-- Metadata Overlay -->
                <div class="ranked-meta">
                  <div class="ranked-title">${item.title || item.name}</div>
                  <div class="view-counter">
                    <i class="fas fa-eye"></i> ${item.view_count || 1}
                  </div>
                </div>
              </div>
            `;

            wrapper.querySelector('.ranked-card').onclick = () => {
              app.go('detail', { id: item.id, type: type });
            };

            grid.appendChild(wrapper);
          }

          gsap.fromTo('.ranked-wrapper',
            { y: 50, opacity: 0 },
            { y: 0, opacity: 1, duration: 0.5, stagger: 0.05, ease: "back.out(1.2)" }
          );

        } catch (err) {
          console.error(err);
        }
      },
      // --- PROFILE PAGE ---
      /*loadProfile: () => {
        const user = app.state.user;
        if (!user) {
          // Redirect to login if not logged in? Or show guest
          return;
        }

        // 1. Populate Info
        document.getElementById('userPageName').innerText = user.displayName || 'Traveler';
        document.getElementById('userPageEmail').innerText = user.email;
        document.getElementById('userListCount').innerText = app.state.watchlist.length;

        const avatar = document.getElementById('userPageAvatar');
        avatar.src = user.photoURL || "https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png";

        // 2. Populate Grid with Watchlist (or History if you implement it)
        const grid = document.getElementById('userPageGrid');
        grid.innerHTML = '';

        if (app.state.watchlist.length === 0) {
          grid.innerHTML = '<div style="color:#666">Your library is empty.</div>';
        } else {
          app.state.watchlist.forEach(m => {
            const c = ui.card(m, m.media_type);
            if (c) grid.appendChild(c);
          });
        }
      },*/

      loadProfile: async () => {
        const user = app.state.user;

        // 1. Safety Redirect
        if (!user) {
          console.warn("No user logged in, redirecting...");
          return app.go('home');
        }

        console.log("Loading Profile for:", user.email);

        // 2. Render Basic Info IMMEDIATELY (Prevents black screen)
        const nameEl = document.getElementById('userPageName');
        const avatarEl = document.getElementById('userPageAvatar');
        const coverEl = document.getElementById('profileCoverImg');

        if (nameEl) nameEl.innerText = user.displayName || 'Traveler';
        if (avatarEl) avatarEl.src = user.photoURL || "https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png";

        // Set a default background immediately so it's not black
        if (coverEl) coverEl.style.backgroundImage = `url('https://image.tmdb.org/t/p/original/rULWuutDCN5PvwmUdbryohj9lBb.jpg')`;

        // 3. Fetch Data
        let list = [];
        let history = [];

        try {
          const userData = await getUserData(user);
          if (userData) {
            list = userData.watchlist || [];
            history = userData.history || [];
          }
        } catch (e) { console.error("DB Error:", e); }

        // 4. Hydration (Safe Mode)
        const hydrate = async (items) => {
          if (!items || !items.length) return [];
          const results = await Promise.allSettled(items.map(async (item) => {
            // Use existing image if we have it
            if (item.poster_path || item.backdrop_path) return item;
            try {
              // If ID is missing, skip
              if (!item.id) return null;
              const type = item.media_type || 'movie';
              const fresh = await api.get(`/${type}/${item.id}`);
              return fresh ? { ...item, ...fresh, media_type: type } : item;
            } catch (e) { return item; }
          }));
          return results.map(r => r.status === 'fulfilled' ? r.value : null).filter(i => i);
        };

        // Show visual loading state
        const uGrid = document.getElementById('userPageGrid');
        const hGrid = document.getElementById('userHistoryGrid');
        if (uGrid) uGrid.innerHTML = '<div style="color:gray; padding:20px;">Syncing...</div>';
        if (hGrid) hGrid.innerHTML = '<div style="color:gray; padding:20px;">Syncing...</div>';

        // Hydrate Data
        list = await hydrate(list);
        history = await hydrate(history);

        // 5. Update Stats (Safe check for elements)
        const updateText = (id, txt) => { const el = document.getElementById(id); if (el) el.innerText = txt; };

        const mCount = list.filter(i => i.media_type === 'movie').length;
        const tCount = list.filter(i => i.media_type === 'tv').length;

        updateText('statMovies', mCount);
        updateText('statShows', tCount);
        updateText('statTotalItems', list.length);

        // 6. Update Dynamic Cover Art (if valid)
        const lastItem = history[history.length - 1] || list[list.length - 1];
        if (lastItem && lastItem.backdrop_path && coverEl) {
          coverEl.style.backgroundImage = `url(${IMG_BASE + lastItem.backdrop_path})`;
        }

        // 7. Render Grids
        const renderGrid = (data, containerEl, isHistory) => {
          if (!containerEl) return;
          containerEl.innerHTML = '';

          if (!data.length) {
            containerEl.innerHTML = '<div style="color:#666; padding:20px;">Nothing here yet.</div>';
            return;
          }

          [...data].reverse().forEach(m => {
            if (!m || !m.id) return; // Skip invalid items

            const type = m.media_type || 'movie';
            const c = ui.card(m, type);

            if (c) {
              if (isHistory) {
                c.onclick = () => player.open(m, m.season, m.episode);
                // Add play icon overlay
                c.innerHTML += `<div style="position:absolute;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;pointer-events:none;"><i class="fas fa-play" style="font-size:24px;color:#fff;"></i></div>`;
              }
              containerEl.appendChild(c);
            }
          });
        };

        renderGrid(list, uGrid, false);
        renderGrid(history, hGrid, true);
      },
      // --- TAB SWITCHER HELPER ---
      switchProfileTab: (tabName) => {
        // 1. Handle UI Toggling (Classes & Display)
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        // Use event.currentTarget to safely get the button even if clicking text inside it
        if (event && event.currentTarget) event.currentTarget.classList.add('active');

        document.querySelectorAll('.profile-tab-content').forEach(c => c.style.display = 'none');

        const targetContent = document.getElementById(`tab-${tabName}`);
        if (targetContent) {
          targetContent.style.display = 'block';
          // Animation
          gsap.fromTo(targetContent, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3 });
        }

        // 2. TRIGGER DATA LOADING (The Missing Link)
        if (tabName === 'social') {
          // Load Friends/Requests when tab is clicked
          if (window.socialUI) window.socialUI.loadSocialData();
        }
        else if (tabName === 'analytics') {
          // Load Stats/Trending when tab is clicked
          if (window.analyticsUI) {
            window.analyticsUI.loadUserStats();
            window.analyticsUI.switchTab('feed'); // Default to feed
          }
        }
      },

      toggleAdultSafety: () => {
        const isChecked = document.getElementById('settingSafetyFilter').checked;
        localStorage.setItem('aether_adult_safety', isChecked);

        // Visual Feedback
        if (isChecked) alert("Safety Filter Active. Sensitive searches will now trigger a security warning.");
      },
      renderEpisodes: async (params) => {
        const { episodes, seasonNumber, showName, showId } = params;
        const dtEpisodes = document.getElementById('dtEpisodes');

        // Settings
        const INITIAL_LIMIT = 5;
        dtEpisodes.innerHTML = '';

        if (!episodes || episodes.length === 0) {
          dtEpisodes.innerHTML = '<div style="color:var(--text-muted)">No episodes found.</div>';
          return;
        }

        // --- CARD CREATOR ---
        const createCard = (ep, index) => {
          const imgUrl = ep.still_path ? POSTER_BASE + ep.still_path : '';
          const imgHtml = imgUrl
            ? `<img class="episode-img" src="${imgUrl}" loading="lazy" alt="${ep.name}">`
            : `<div class="episode-img" style="display:flex;align-items:center;justify-content:center;background:#1a1a1a;color:#555;">No Image</div>`;

          const div = document.createElement('div');
          div.className = 'episode-card';

          // Exact structure matching your CSS
          div.innerHTML = `
            ${imgHtml}
            <div class="episode-info">
              <h4 class="episode-title">${index + 1}. ${ep.name}</h4>
              <div>${ep.air_date || 'Unknown'} • ${ep.runtime ? ep.runtime + 'm' : 'N/A'}</div>
                  <p>${ep.overview || 'No description available.'}</p>
              </div>
            <i class="fas fa-play-circle" style="font-size:24px; color:var(--text-muted); flex-shrink:0;"></i>
          `;

          div.onclick = () => {
            // Play specific episode
            player.open(
              { id: showId, name: showName }, // Media Object
              seasonNumber,                   // Season
              ep.episode_number               // Episode
            );
          };
          return div;
        };

        // --- RENDER VISIBLE (First 5) ---
        const initialBatch = episodes.slice(0, INITIAL_LIMIT);
        initialBatch.forEach((ep, idx) => {
          dtEpisodes.appendChild(createCard(ep, idx));
        });

        // --- RENDER HIDDEN (The Rest) ---
        const remainingEpisodes = episodes.slice(INITIAL_LIMIT);

        if (remainingEpisodes.length > 0) {
          // Wrapper
          const hiddenWrapper = document.createElement('div');
          hiddenWrapper.className = 'hidden-episodes-wrapper';

          remainingEpisodes.forEach((ep, idx) => {
            hiddenWrapper.appendChild(createCard(ep, idx + INITIAL_LIMIT));
          });

          dtEpisodes.appendChild(hiddenWrapper);

          // Button Container
          const btnContainer = document.createElement('div');
          btnContainer.className = 'load-more-row';

          // Button
          const btn = document.createElement('button');
          btn.className = 'expand-episodes-btn';
          btn.innerHTML = `Show ${remainingEpisodes.length} More Episodes <i class="fas fa-chevron-down"></i>`;

          // Toggle Logic
          btn.onclick = () => {
            const isExpanded = btn.classList.contains('active');

            if (isExpanded) {
              // CLOSE
              btn.classList.remove('active');
              btn.innerHTML = `Show ${remainingEpisodes.length} More Episodes <i class="fas fa-chevron-down"></i>`;

              gsap.to(hiddenWrapper, { height: 0, opacity: 0, duration: 0.5, ease: "power3.inOut" });

            } else {
              // OPEN
              btn.classList.add('active');
              btn.innerHTML = `Show Less <i class="fas fa-chevron-up"></i>`;

              gsap.set(hiddenWrapper, { height: "auto" });
              gsap.from(hiddenWrapper, { height: 0, duration: 0.5, ease: "power3.out" });
              gsap.to(hiddenWrapper, { opacity: 1, duration: 0.5, delay: 0.1 });
            }
          };

          btnContainer.appendChild(btn);
          dtEpisodes.appendChild(btnContainer);
        }

        // Entry Animation
        gsap.fromTo('.episode-card',
          { y: 20, opacity: 0 },
          { y: 0, opacity: 1, duration: 0.4, stagger: 0.05, ease: "power2.out" }
        );
      },


      initNetworkView: async (params) => {
        app.state.currentParams = params;
        app.state.pages = { movie: 1, tv: 1 };
        document.getElementById('netTitle').innerText = params.name;
        document.getElementById('netMovieGrid').innerHTML = '';
        document.getElementById('netTvGrid').innerHTML = '';
        await Promise.all([app.loadMore('movie', true), app.loadMore('tv', true)]);
      },

      loadMore: async (type, reset = false) => {
        const gridId = type === 'movie' ? 'netMovieGrid' : 'netTvGrid';
        const btnId = type === 'movie' ? 'loadMoreMovieBtn' : 'loadMoreTvBtn';
        const grid = document.getElementById(gridId);
        const btn = document.getElementById(btnId);
        const p = app.state.currentParams;
        let endpoint = '/discover/' + type;
        let queryParams = { page: app.state.pages[type], watch_region: 'US' };
        if (p.type === 'genre') {
          let genreId = p.id;
          if (type === 'tv' && GENRE_MAP[p.id]) genreId = GENRE_MAP[p.id];
          if (type === 'tv' && !GENRE_MAP[p.id] && p.id !== 10759 && p.id !== 10765) queryParams.sort_by = 'popularity.desc';
          else queryParams.with_genres = genreId;
        } else if (p.type === 'provider') queryParams.with_watch_providers = p.id;
        const res = await api.get(endpoint, queryParams);
        if (!res.results || res.results.length === 0) {
          if (reset) document.getElementById(type === 'movie' ? 'netMovieSection' : 'netTvSection').style.display = 'none';
          btn.style.display = 'none';
          return;
        }
        const safeResults = app.filterSafeContent(res.results);
        document.getElementById(type === 'movie' ? 'netMovieSection' : 'netTvSection').style.display = 'block';
        const frag = document.createDocumentFragment();
        const newCards = [];
        res.results.forEach(m => {
          const c = ui.card(m, type);
          if (c) { frag.appendChild(c); newCards.push(c); }
        });
        safeResults.forEach(m => {
          const c = ui.card(m, type);
          if (c) { frag.appendChild(c); newCards.push(c); }
        });
        grid.appendChild(frag);
        if (newCards.length) gsap.fromTo(newCards, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.4, stagger: 0.05, clearProps: 'all' });
        if (res.page < res.total_pages) { btn.style.display = 'block'; app.state.pages[type]++; } else { btn.style.display = 'none'; }
      },

      /*toggleWatchlist: (m) => {
        const idx = app.state.watchlist.findIndex(i => i.id === m.id);
        if (idx > -1) app.state.watchlist.splice(idx, 1);
        else { if (!m.media_type) m.media_type = m.title ? 'movie' : 'tv'; app.state.watchlist.push(m); }
        localStorage.setItem('aether_wl', JSON.stringify(app.state.watchlist));
        const btns = ['heroListBtn', 'dtListBtn'];
        btns.forEach(id => { const el = document.getElementById(id); if (el && document.body.contains(el)) app.updateListBtn(el, m.id); });
      },*/

      toggleWatchlist: async (m) => {
        const idx = app.state.watchlist.findIndex(i => i.id === m.id);

        // Ensure media type is set
        if (!m.media_type) m.media_type = m.title ? 'movie' : 'tv';

        if (idx > -1) {
          // REMOVE
          const itemToRemove = app.state.watchlist[idx]; // Need exact ref for local logic
          app.state.watchlist.splice(idx, 1);

          // Cloud Sync
          if (app.state.user) {
            await removeFromCloudList(app.state.user, itemToRemove);
          }
        } else {
          // ADD
          app.state.watchlist.push(m);

          // Cloud Sync
          if (app.state.user) {
            // Firebase doesn't like complex objects with undefined values sometimes,
            // so we create a clean object to save.
            const cleanMovie = {
              id: m.id,
              title: m.title || m.name,
              poster_path: m.poster_path || null,
              backdrop_path: m.backdrop_path || null,
              media_type: m.media_type,

              release_date: m.release_date || m.first_air_date || '',
              vote_average: m.vote_average || 0,
            };
            await addToCloudList(app.state.user, cleanMovie);
          }
        }

        // Local Backup (optional, good for offline)
        localStorage.setItem('aether_wl', JSON.stringify(app.state.watchlist));

        // Update Buttons
        const btns = ['heroListBtn', 'dtListBtn'];
        btns.forEach(id => {
          const el = document.getElementById(id);
          if (el && document.body.contains(el)) app.updateListBtn(el, m.id);
        });

        // If on watchlist page, re-render
        if (document.getElementById('view-watchlist').classList.contains('active')) {
          app.renderWatchlist();
        }
      },

      updateListBtn: (btn, id) => {
        const inList = app.state.watchlist.some(i => i.id === id);
        btn.innerHTML = inList ? '<i class="fas fa-check"></i> Saved' : '<i class="fas fa-plus"></i> Add to List';
        btn.style.color = inList ? 'var(--accent)' : '#fff';
        btn.style.borderColor = inList ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
      },
      /*renderWatchlist: () => {
        const grid = document.getElementById('watchlistGrid');
        grid.innerHTML = '';
        if (!app.state.watchlist.length) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666">Your list is empty</div>';
        app.state.watchlist.forEach(m => { const c = ui.card(m, m.media_type); if (c) grid.appendChild(c); });
        gsap.from(grid.children, { scale: 0.9, opacity: 0, stagger: 0.05 });
      },*/

      renderWatchlist: async () => {
        const grid = document.getElementById('watchlistGrid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:gray;">Syncing library...</div>';

        let list = app.state.watchlist || [];

        if (!list.length) {
          grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666">Your list is empty</div>';
          return;
        }

        // HYDRATE LOOP
        const hydratedList = await Promise.all(list.map(async (item) => {
          if (item.poster_path) return item; // Have image, skip fetch
          try {
            const type = item.media_type || 'movie';
            const res = await api.get(`/${type}/${item.id}`);
            // Return merged data
            return res.poster_path ? { ...item, ...res, media_type: type } : item;
          } catch (e) { return item; }
        }));

        // Update App State so we don't fetch again this session
        app.state.watchlist = hydratedList;

        grid.innerHTML = '';
        hydratedList.forEach(m => {
          // Allow card to render even if image is still missing (via placeholder)
          const c = ui.card(m, m.media_type);
          if (c) grid.appendChild(c);
        });

        gsap.from(grid.children, { scale: 0.9, opacity: 0, stagger: 0.05 });
      },

      playVideo: async (id, type, titleData = '') => {
        const modal = document.getElementById('videoModal');
        const bg = document.querySelector('.modal-bg');
        const wrapper = document.getElementById('videoWrapper');
        const container = document.getElementById('videoContainer');
        const loader = document.getElementById('videoLoader');
        const header = document.querySelector('.video-header');
        const closeBtn = document.querySelector('.close-video-btn');
        const titleLabel = document.getElementById('videoTitleLabel');

        const key = await api.findVideo(id, type);
        if (!key) { return; }

        let displayTitle = "Aether Original";
        if (typeof titleData === 'string' && titleData !== '') displayTitle = titleData;
        else if (app.state.currentMedia) displayTitle = app.state.currentMedia.title || app.state.currentMedia.name;
        titleLabel.innerText = displayTitle;

        container.innerHTML = '';
        modal.classList.add('active');
        loader.style.display = 'flex';
        loader.style.opacity = 1;

        const tl = gsap.timeline();
        tl.to(modal, { autoAlpha: 1, duration: 0 })
          .to(bg, { opacity: 1, duration: 0.4, ease: "power2.out" })
          .fromTo(wrapper, { scale: 0.8, clipPath: "inset(0 50% 0 50%)", opacity: 0 }, { scale: 1, clipPath: "inset(0 0% 0 0%)", opacity: 1, duration: 0.8, ease: "expo.inOut" }, "-=0.2")
          .fromTo([header, closeBtn], { y: -20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.4, stagger: 0.1, ease: "power2.out" }, "-=0.4");

        setTimeout(() => {
          container.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${key}?autoplay=1&rel=0&modestbranding=1&showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
          gsap.to(loader, { opacity: 0, duration: 0.5, onComplete: () => loader.style.display = 'none' });
        }, 600);
      },

      closeVideo: () => {
        const modal = document.getElementById('videoModal');
        const bg = document.querySelector('.modal-bg');
        const wrapper = document.getElementById('videoWrapper');
        const header = document.querySelector('.video-header');
        const closeBtn = document.querySelector('.close-video-btn');

        const tl = gsap.timeline({
          onComplete: () => {
            modal.classList.remove('active');
            document.getElementById('videoContainer').innerHTML = '';
          }
        });
        tl.to([header, closeBtn], { opacity: 0, duration: 0.2 })
          .to(wrapper, { clipPath: "inset(0 50% 0 50%)", scale: 0.9, opacity: 0, duration: 0.5, ease: "power3.inOut" })
          .to(bg, { opacity: 0, duration: 0.3 }, "-=0.3");
      },

      toggleSearch: () => {
        app.state.searchOpen = !app.state.searchOpen;
        const overlay = document.getElementById('searchOverlay');
        const input = document.getElementById('searchInput');
        if (app.state.searchOpen) { overlay.classList.add('open'); setTimeout(() => input.focus(), 500); }
        else { overlay.classList.remove('open'); input.blur(); }
      },
      searchTimeout: null, // Add this state variable

      /*handleSearch: (e) => {
        const query = e.target.value;
        const container = document.getElementById('searchResults');

        // 1. IMMEDIATE SAFETY CHECK (Runs on every keystroke)
        if (!app.checkSafety(query)) {
          container.innerHTML = '';
          return; // Stop immediately
        }

        if (query.length < 2) {
          container.innerHTML = '';
          return;
        }

        // 2. DEBOUNCE API CALL
        // Clear previous timer
        if (app.searchTimeout) clearTimeout(app.searchTimeout);

        // Wait 300ms after user stops typing to actually call API
        app.searchTimeout = setTimeout(async () => {
          const res = await api.get('/search/multi', { query });

          // Render results...
          container.innerHTML = '';
          if (res && res.results) {
            const valid = res.results.filter(i => i.media_type === 'movie' || i.media_type === 'tv');
            valid.forEach(m => { const c = ui.card(m); if (c) container.appendChild(c); });
          }
        }, 300); // 300ms delay
      },*/

      // Inside the app object...

      handleSearch: (e) => {
        const query = e.target.value;
        const container = document.getElementById('searchResults');

        if (query.length < 2) {
          container.innerHTML = '';
          return;
        }

        // Clear previous debounce
        if (app.searchTimeout) clearTimeout(app.searchTimeout);

        app.searchTimeout = setTimeout(async () => {

          // 1. CHECK FOR DANGER
          // We use the strict regex list you defined earlier
          const isRisky = app.checkSafetySimple(query);

          if (isRisky) {
            // 🛑 HIT DETECTED!
            // Do not block yet. Try to find SAFE alternatives first.
            console.log("Risky term detected. Attempting Safe Fallback...");
            await app.runSafeSearch(query);
          } else {
            // ✅ CLEAN SEARCH
            const res = await api.get('/search/multi', { query });
            app.renderSearchResults(res, query, false); // false = normal mode
          }

        }, 300); // 300ms delay
      },

      // HELPER: Sanitize a list of movies for Kids
      filterSafeContent: (items) => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';
        if (!isKids) return items; // Adults see everything

        // Blacklist Config
        const badGenres = [27, 80, 53, 10752, 18]; // Horror, Crime, Thriller, War, Drama

        // Use the strict regex list we created earlier
        const hasBadWord = (text) => RESTRICTED_TERMS.some(pattern => pattern.test(text));

        return items.filter(m => {
          // 1. Drop if no image (Low quality junk)
          if (!m.poster_path && !m.backdrop_path) return false;

          // 2. Drop by Genre
          if (m.genre_ids && m.genre_ids.some(g => badGenres.includes(g))) return false;

          // 3. Drop by Adult Flag
          if (m.adult) return false;

          // 4. Drop by Title/Desc Analysis (The "Hentai" filter)
          const text = (m.title || m.name || "") + " " + (m.overview || "");
          if (hasBadWord(text)) return false;

          return true;
        });
      },

      // Helper to just check regex (returns boolean, doesn't trigger modal)
      checkSafetySimple: (query) => {
        const isKids = localStorage.getItem('aether_is_kids') === 'true';
        const isAdultSafety = localStorage.getItem('aether_adult_safety') === 'true';
        if (!isKids && !isAdultSafety) return false;
        return RESTRICTED_TERMS.some(pattern => pattern.test(query));
      },


      runSafeSearch: async (query) => {
        const container = document.getElementById('searchResults');

        // 1. Force strict parameters regardless of settings
        // We search for movies/tv that contain the letters but are rated G/PG
        const safeRes = await api.get('/search/multi', {
          query: query,
          certification_country: "US",
          certification_lte: "PG", // STRICTLY PG or lower
          without_genres: "27,80,53,10752,18" // No Horror, Crime, War, Drama
        });

        // 2. Double Check Results (Title Scanning)
        // Even if TMDB says it's PG, if the title contains the bad word EXACTLY, remove it.
        let safeItems = [];
        if (safeRes && safeRes.results) {
          safeItems = safeRes.results.filter(m => {
            const title = (m.title || m.name || "").toLowerCase();
            // Exclude if it is clearly adult (extra safety)
            if (m.adult) return false;
            // Keep content only if it has an image (usually higher quality/safe)
            if (!m.poster_path) return false;
            return true;
          });
        }

        // 3. DECISION MOMENT
        if (safeItems.length > 0) {
          // 🎉 SUCCESS: We found safe things (e.g., input "Hell" -> found "Hello Kitty")
          app.renderSearchResults({ results: safeItems }, query, true); // true = Safe Mode
        } else {
          // 💀 FAIL: We found nothing safe. This is likely a purely dirty search.
          // NOW we trigger the scare.
          app.triggerSecurityProtocol();
        }
      },

      // Helper to Render (to avoid code duplication)
      renderSearchResults: (res, query, isSafeMode) => {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';

        if (isSafeMode) {
          // Inject the "Safe Suggestions" Panel
          const panel = document.createElement('div');
          panel.className = 'safe-suggestion-panel';
          panel.innerHTML = `
            <div class="safe-suggestion-icon"><i class="fas fa-shield-alt"></i></div>
            <div class="safe-suggestion-text">
                <h3>Safe Search Suggestions</h3>
                <p>We filtered results for "<strong>${query}</strong>" to show only family-friendly content.</p>
            </div>
          `;
          container.appendChild(panel);
        }

        const valid = res.results.filter(i => i.media_type === 'movie' || i.media_type === 'tv');
        if (valid.length === 0 && !isSafeMode) {
          container.innerHTML = '<div style="color:#666; padding:20px;">No results found.</div>';
          return;
        }

        valid.forEach(m => {
          const c = ui.card(m);
          if (c) container.appendChild(c);
        });
      },
      toggleMenu: () => {
        app.state.menuOpen = !app.state.menuOpen;
        const menu = document.getElementById('fsMenu');
        const links = document.querySelectorAll('.fs-link');
        if (app.state.menuOpen) {
          menu.classList.add('active');
          gsap.to(menu, { clipPath: 'circle(150% at 94% 5%)', duration: 0.8, ease: 'power3.inOut' });
          gsap.to(links, { y: 0, opacity: 1, duration: 0.8, stagger: 0.05, delay: 0.2, ease: 'power4.out' });
          gsap.to('.burger-line:nth-child(1)', { rotation: 45, y: 5 });
          gsap.to('.burger-line:nth-child(2)', { rotation: -45, width: '100%', y: -5 });
          document.querySelector('.menu-trigger span').style.color = '#000';
        } else {
          menu.classList.remove('active');
          gsap.to(menu, { clipPath: 'circle(0% at 94% 5%)', duration: 0.6, ease: 'power3.inOut' });
          gsap.to(links, { y: '100%' });
          gsap.to('.burger-line:nth-child(1)', { rotation: 0, y: 0 });
          gsap.to('.burger-line:nth-child(2)', { rotation: 0, width: '60%', y: 0 });
          document.querySelector('.menu-trigger span').style.color = '#fff';
        }
      },
      toggleSidebar: (force) => {
        const sb = document.getElementById("genreSidebar");
        // Toggle State
        app.state.sidebarOpen = force !== undefined ? force : !app.state.sidebarOpen;

        if (app.state.sidebarOpen) {
          gsap.to(sb, { x: 0, duration: 0.5, ease: "power4.out" });
          gsap.to("main", { filter: "blur(5px) brightness(0.4)", duration: 0.5 });

          // Stagger the list items in
          gsap.fromTo('.genre-item',
            { x: -20, opacity: 0 },
            { x: 0, opacity: 1, duration: 0.4, stagger: 0.03, delay: 0.1 }
          );

          // Focus search
          setTimeout(() => document.getElementById('genreFilterInput').focus(), 400);
        } else {
          gsap.to(sb, { x: "-105%", duration: 0.5, ease: "power4.in" });
          gsap.to("main", { filter: "blur(0px) brightness(1)", duration: 0.5 });
        }
      },

      initSidebarFeatures: async () => {
        // 1. POPULATE STATIC NAV
        const dList = document.getElementById("discoverList");
        const discoverItems = [
          { name: "Home", icon: "fa-home", action: () => app.go('home') },
          { name: "Originals", icon: "fa-crown", action: () => app.go('originals') },
          { name: "Trending", icon: "fa-fire", action: () => app.go('network', { id: 'trending', name: 'Trending', type: 'special' }) },
          { name: "Top Rated", icon: "fa-star", action: () => app.go('network', { id: 'top_rated', name: 'Top Rated', type: 'special' }) },
          { name: "Watchlist", icon: "fa-bookmark", action: () => app.go('watchlist') },
          { name: "Constellation", icon: "fa-atom", action: () => app.openConstellation() },
        ];

        dList.innerHTML = '';
        discoverItems.forEach(item => {
          const el = document.createElement("div");
          el.className = "nav-item";
          el.innerHTML = `<i class="fas ${item.icon}"></i> ${item.name}`;
          el.onclick = () => { app.toggleSidebar(false); item.action(); };
          dList.appendChild(el);
        });

        // 2. POPULATE GENRES (TAGS)
        const genres = [
          { id: 28, name: "Action" }, { id: 12, name: "Adventure" }, { id: 35, name: "Comedy" },
          { id: 80, name: "Crime" }, { id: 99, name: "Documentary" }, { id: 18, name: "Drama" },
          { id: 10751, name: "Family" }, { id: 14, name: "Fantasy" }, { id: 36, name: "History" },
          { id: 27, name: "Horror" }, { id: 10402, name: "Music" }, { id: 9648, name: "Mystery" },
          { id: 10749, name: "Romance" }, { id: 878, name: "Sci-Fi" }, { id: 53, name: "Thriller" },
          { id: 10752, name: "War" }, { id: 37, name: "Western" }
        ];

        const gList = document.getElementById("genreList");
        gList.innerHTML = '';
        genres.forEach(g => {
          const el = document.createElement("div");
          el.className = "genre-tag"; // New class
          el.innerText = g.name;
          el.setAttribute('data-name', g.name.toLowerCase());
          el.onclick = () => {
            app.toggleSidebar(false);
            app.go("network", { id: g.id, name: g.name, type: "genre" });
          };
          gList.appendChild(el);
        });

        // 3. SEARCH FILTER LOGIC
        document.getElementById('genreFilterInput').addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();

          // Filter Nav Items
          const navs = dList.querySelectorAll('.nav-item');
          navs.forEach(n => {
            if (n.innerText.toLowerCase().includes(term)) n.style.display = 'flex';
            else n.style.display = 'none';
          });

          // Filter Genres
          const tags = gList.querySelectorAll('.genre-tag');
          tags.forEach(t => {
            if (t.innerText.toLowerCase().includes(term)) t.style.display = 'block';
            else t.style.display = 'none';
          });
        });

        // 4. LOAD USER DATA & HISTORY (New!)
        const user = app.state.user;
        if (user) {
          // Footer Info
          document.getElementById('sidebarName').innerText = user.displayName || 'Traveler';
          document.getElementById('sidebarAvatar').src = user.photoURL || "https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png";

          // Load Quick History
          // We use the existing getUserData helper
          import("./js/firebase/db.js").then(async ({ getUserData }) => {
            const data = await getUserData(user);
            const history = data.history || [];

            const histContainer = document.getElementById('sidebarHistoryList');
            const histSection = document.getElementById('sidebarHistorySection');

            if (history.length > 0) {
              histSection.style.display = 'block';
              histContainer.innerHTML = '';

              // Show last 3 items
              const recent = history.slice(-3).reverse();

              recent.forEach(m => {
                if (!m.poster_path) return;
                const div = document.createElement('div');
                div.className = 'mini-history-card';
                div.innerHTML = `
                      <img src="https://image.tmdb.org/t/p/w200${m.poster_path}" class="mini-history-img">
                      <div class="mini-history-info">
                          <h4>${m.title || m.name}</h4>
                          <span>${m.media_type === 'tv' && m.season ? `S${m.season} E${m.episode}` : 'Resume'}</span>
                      </div>
                  `;
                // Click to Resume
                div.onclick = () => {
                  app.toggleSidebar(false);
                  window.player.open(m, m.season, m.episode);
                };
                histContainer.appendChild(div);
              });
            }
          });
        }
      },

      openConstellation: async () => {
        // 1. Determine Seed Movie
        let seed = app.state.currentMedia;

        // If no movie is selected yet, fetch a random trending one
        if (!seed) {
          try {
            const trending = await api.get('/trending/movie/day');
            if (trending.results && trending.results.length > 0) {
              seed = trending.results[0];
            }
          } catch (e) { }
        }

        if (!seed) return alert("Please select a movie first to explore.");

        // 2. Switch View
        app.go('constellation');

        // 3. Generate Graph
        // Wait for view transition
        setTimeout(() => {
          if (window.constellationUI) {
            window.constellationUI.generate(seed);
          }
        }, 100);
      },

      enableDrag: (el) => {
        let isDown = false; let startX; let scrollLeft;
        el.addEventListener('mousedown', (e) => { isDown = true; el.style.cursor = 'grabbing'; startX = e.pageX - el.offsetLeft; scrollLeft = el.scrollLeft; });
        el.addEventListener('mouseleave', () => { isDown = false; el.style.cursor = 'grab'; });
        el.addEventListener('mouseup', () => { isDown = false; el.style.cursor = 'grab'; });
        el.addEventListener('mousemove', (e) => {
          if (!isDown) return; e.preventDefault();
          const x = e.pageX - el.offsetLeft; const walk = (x - startX) * 2;
          el.scrollLeft = scrollLeft - walk;
        });
      },
      profileClick: () => { app.go('settings'); },
      switchSettingTab: (tabId, btnEl) => {
        document.querySelectorAll('.set-tab').forEach(t => t.classList.remove('active'));
        btnEl.classList.add('active');
        const panels = document.querySelectorAll('.set-panel');
        panels.forEach(p => {
          if (p.classList.contains('active')) {
            gsap.to(p, { opacity: 0, y: -10, duration: 0.2, onComplete: () => { p.classList.remove('active'); p.style.display = 'none'; } });
          }
        });
        setTimeout(() => {
          const target = document.getElementById(`set-${tabId}`);
          target.style.display = 'block';
          target.classList.add('active');
          gsap.fromTo(target, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.4, ease: "power2.out" });
        }, 250);
      }
    };

    // Avatar Physics (External)
    const initAvatar = () => {
      const wrap = document.querySelector('.profile-wrapper');
      const inner = document.querySelector('.profile-inner');
      const img = document.querySelector('.profile-img');
      const glow = document.querySelector('.profile-glow');
      wrap.addEventListener('mousemove', (e) => {
        const rect = wrap.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        gsap.to(wrap, { x: x * 0.4, y: y * 0.4, rotation: x * 0.5, duration: 0.3, ease: 'power2.out' });
        gsap.to(img, { x: -x * 0.3, y: -y * 0.3, duration: 0.3, ease: 'power2.out' });
        gsap.to(glow, { x: x, y: y, scale: 1, opacity: 0.6, duration: 0.3 });
      });
      wrap.addEventListener('mouseleave', () => {
        gsap.to([wrap, img], { x: 0, y: 0, rotation: 0, duration: 0.8, ease: 'elastic.out(1, 0.4)' });
        gsap.to(glow, { scale: 0, opacity: 0, duration: 0.3, x: '-50%', y: '-50%' });
      });
      wrap.addEventListener('mousedown', () => {
        gsap.to(inner, { scale: 0.9, duration: 0.1, ease: 'power2.out', onComplete: () => { gsap.to(inner, { scale: 1, duration: 0.4, ease: 'elastic.out(1, 0.3)' }); } });
      });
    };

    const createCard = (ep, index) => {
      const imgUrl = ep.still_path ? POSTER_BASE + ep.still_path : '';
      // Use a placeholder if no image
      const imgHtml = imgUrl
        ? `<img class="episode-img" src="${imgUrl}" loading="lazy" alt="${ep.name}">`
        : `<div class="episode-img" style="display:flex;align-items:center;justify-content:center;background:#1a1a1a;color:#555;width:100%;height:100%;"><i class="fas fa-image" style="font-size:24px;"></i></div>`;

      const div = document.createElement('div');
      div.className = 'episode-card';

      // Updated HTML Structure
      div.innerHTML = `
      <div class="episode-img-wrap">
        ${imgHtml}
      </div>
      
      <div class="episode-info">
        <h4 class="episode-title">${index + 1}. ${ep.name}</h4>
        <div class="episode-meta">
          <span>${ep.air_date ? ep.air_date.split('-')[0] : ''}</span>
          ${ep.runtime ? `<span>• ${ep.runtime}m</span>` : ''}
        </div>
        <p class="episode-desc">${ep.overview || 'No overview available for this episode.'}</p>
      </div>

      <div class="episode-play">
        <i class="fas fa-play" style="font-size: 14px; margin-left: 2px;"></i>
      </div>
    `;

      div.onclick = () => app.playVideo(showId, 'tv', `${showName}: S${seasonNumber} E${ep.episode_number} - ${ep.name}`);
      return div;
    };


    // Attach to window so HTML clicks work
    window.app = app;
    window.socialUI = socialUI;
    window.analyticsUI = analyticsUI;
    window.watchPartyUI = watchPartyUI;
    window.oracleUI = oracleUI;
    window.actorUI = actorUI;

    // Initialize
    app.init();
    socialUI.init();
    analyticsUI.init();
    oracleUI.init();
    actorUI.init();
    // In app.init():
    constellationUI.init();
    lensUI.init();


    //watchPartyUI.init().catch(err => console.error('Error initializing Watch Party UI:', err));
  </script>
</body>

</html>